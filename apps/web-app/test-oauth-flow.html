<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test OAuth Flow - AutaMedica</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(to bottom, #111827, #1f2937);
            color: white;
            padding: 2rem;
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .test-section {
            background: rgba(31, 41, 55, 0.5);
            border: 1px solid #4b5563;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .status {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            margin-left: 0.5rem;
        }
        .status.success { background: #10b981; }
        .status.error { background: #ef4444; }
        .status.warning { background: #f59e0b; }
        .status.info { background: #3b82f6; }
        button {
            background: #10b981;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
            cursor: pointer;
            margin: 0.25rem;
        }
        button:hover {
            background: #059669;
        }
        pre {
            background: #000;
            padding: 1rem;
            border-radius: 0.25rem;
            overflow-x: auto;
            font-size: 0.875rem;
        }
        .log {
            margin: 0.5rem 0;
            padding: 0.5rem;
            background: rgba(0, 0, 0, 0.3);
            border-left: 3px solid #3b82f6;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç OAuth Flow Test - AutaMedica</h1>
        
        <div class="test-section">
            <h2>1. Configuraci√≥n Actual</h2>
            <div id="config-info"></div>
        </div>

        <div class="test-section">
            <h2>2. Test de Redirecci√≥n OAuth</h2>
            <button onclick="testGoogleOAuth()">Test Google OAuth</button>
            <button onclick="testGitHubOAuth()">Test GitHub OAuth</button>
            <div id="oauth-results"></div>
        </div>

        <div class="test-section">
            <h2>3. An√°lisis de URL Callback</h2>
            <button onclick="analyzeCallback()">Analizar Callback Actual</button>
            <div id="callback-analysis"></div>
        </div>

        <div class="test-section">
            <h2>4. Logs en Tiempo Real</h2>
            <div id="logs"></div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://gtyvdircfhmdjiaelqkg.supabase.co';
        const SUPABASE_ANON_KEY = 'REPLACE_WITH_ROTATED_KEY.7UFMVZsWTWOAynnhzkG76I_lhVCYtd_RmTt9EH3wJD4';
        
        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const logEntry = document.createElement('div');
            logEntry.className = 'log';
            logEntry.style.borderLeftColor = type === 'error' ? '#ef4444' : 
                                            type === 'success' ? '#10b981' : 
                                            type === 'warning' ? '#f59e0b' : '#3b82f6';
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logsDiv.insertBefore(logEntry, logsDiv.firstChild);
        }

        function showConfig() {
            const configDiv = document.getElementById('config-info');
            const isProduction = window.location.hostname !== 'localhost';
            const callbackUrl = isProduction 
                ? 'https://72c09bcd.autamedica-web-app.pages.dev/auth/callback'
                : 'http://localhost:3000/auth/callback';
            
            configDiv.innerHTML = `
                <p><strong>Environment:</strong> <span class="status ${isProduction ? 'info' : 'warning'}">${isProduction ? 'Production' : 'Development'}</span></p>
                <p><strong>Current URL:</strong> ${window.location.href}</p>
                <p><strong>Callback URL:</strong> ${callbackUrl}</p>
                <p><strong>Supabase URL:</strong> ${SUPABASE_URL}</p>
                <p><strong>OAuth Flow:</strong> <span class="status info">Implicit (response_type=token)</span></p>
                <p><strong>Expected Token Location:</strong> URL Hash Fragment (#access_token=...)</p>
            `;
            
            log('Configuraci√≥n cargada', 'info');
        }

        async function testGoogleOAuth() {
            log('Iniciando test de Google OAuth...', 'info');
            const resultsDiv = document.getElementById('oauth-results');
            
            const redirectUrl = buildOAuthUrl('google');
            
            resultsDiv.innerHTML = `
                <h3>Google OAuth URL:</h3>
                <pre>${redirectUrl}</pre>
                <p>Esta URL deber√≠a:</p>
                <ul style="margin-left: 2rem;">
                    <li>‚úÖ Redirigir a accounts.google.com</li>
                    <li>‚úÖ Incluir response_type=token para flujo impl√≠cito</li>
                    <li>‚úÖ Retornar tokens en el hash fragment (#access_token=...)</li>
                    <li>‚úÖ NO retornar un c√≥digo de autorizaci√≥n</li>
                </ul>
                <button onclick="window.open('${redirectUrl}', '_blank')">Abrir en nueva ventana</button>
            `;
            
            log('URL de Google OAuth generada', 'success');
        }

        async function testGitHubOAuth() {
            log('Iniciando test de GitHub OAuth...', 'info');
            const resultsDiv = document.getElementById('oauth-results');
            
            const redirectUrl = buildOAuthUrl('github');
            
            resultsDiv.innerHTML = `
                <h3>GitHub OAuth URL:</h3>
                <pre>${redirectUrl}</pre>
                <p>Esta URL deber√≠a:</p>
                <ul style="margin-left: 2rem;">
                    <li>‚úÖ Redirigir a github.com/login/oauth</li>
                    <li>‚úÖ Incluir response_type=token para flujo impl√≠cito</li>
                    <li>‚úÖ Retornar tokens en el hash fragment (#access_token=...)</li>
                    <li>‚úÖ NO retornar un c√≥digo de autorizaci√≥n</li>
                </ul>
                <button onclick="window.open('${redirectUrl}', '_blank')">Abrir en nueva ventana</button>
            `;
            
            log('URL de GitHub OAuth generada', 'success');
        }

        function buildOAuthUrl(provider) {
            const isProduction = window.location.hostname !== 'localhost';
            const callbackUrl = isProduction 
                ? 'https://72c09bcd.autamedica-web-app.pages.dev/auth/callback'
                : 'http://localhost:3000/auth/callback';
            
            const params = new URLSearchParams({
                response_type: 'token', // Force implicit flow
                client_id: 'sb-gtyvdircfhmdjiaelqkg',
                redirect_uri: callbackUrl,
                scope: provider === 'google' ? 'openid profile email' : 'read:user user:email',
                prompt: 'consent'
            });
            
            const baseUrl = `${SUPABASE_URL}/auth/v1/authorize`;
            return `${baseUrl}?provider=${provider}&${params.toString()}`;
        }

        function analyzeCallback() {
            const analysisDiv = document.getElementById('callback-analysis');
            const url = new URL(window.location.href);
            const hash = window.location.hash;
            const hashParams = new URLSearchParams(hash.substring(1));
            const queryParams = new URLSearchParams(url.search);
            
            let html = '<h3>An√°lisis de Callback:</h3>';
            
            if (hash) {
                html += '<h4>Hash Fragment (Implicit Flow):</h4>';
                html += '<pre>' + hash + '</pre>';
                
                if (hashParams.get('access_token')) {
                    html += '<p class="status success">‚úÖ Access token encontrado en hash</p>';
                    log('Access token detectado en hash fragment', 'success');
                    
                    // Simulate what the callback page should do
                    html += `
                        <p><strong>Pr√≥ximos pasos del callback:</strong></p>
                        <ol style="margin-left: 2rem;">
                            <li>Extraer access_token del hash</li>
                            <li>Llamar a supabase.auth.setSession()</li>
                            <li>Obtener perfil del usuario</li>
                            <li>Redirigir seg√∫n el rol</li>
                        </ol>
                    `;
                } else {
                    html += '<p class="status warning">‚ö†Ô∏è No se encontr√≥ access_token en hash</p>';
                }
            }
            
            if (queryParams.get('code')) {
                html += '<h4>Query Parameters (PKCE Flow - No compatible):</h4>';
                html += '<pre>?code=' + queryParams.get('code') + '</pre>';
                html += '<p class="status error">‚ùå C√≥digo de autorizaci√≥n detectado (PKCE no soportado en sitios est√°ticos)</p>';
                log('C√≥digo PKCE detectado - no compatible con sitios est√°ticos', 'error');
            }
            
            if (!hash && !queryParams.get('code')) {
                html += '<p class="status info">‚ÑπÔ∏è No hay datos de autenticaci√≥n en la URL actual</p>';
            }
            
            analysisDiv.innerHTML = html;
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            showConfig();
            
            // Check if we're on a callback URL
            if (window.location.hash.includes('access_token')) {
                log('‚ö†Ô∏è Access token detectado en la URL actual', 'warning');
                analyzeCallback();
            }
        });

        // Listen for hash changes
        window.addEventListener('hashchange', () => {
            log('Hash fragment cambi√≥', 'info');
            analyzeCallback();
        });
    </script>
</body>
</html>