"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[382],{811:(e,r,t)=>{t.d(r,{T:()=>s});var a=t(1111);let n={video:{width:{ideal:1280},height:{ideal:720},frameRate:{ideal:30}},audio:!0};function s(){let[e,r]=(0,a.useState)(null),[t,s]=(0,a.useState)(null),[i,o]=(0,a.useState)(!1),[l,c]=(0,a.useState)(!1),[u,d]=(0,a.useState)(!1),[g,_]=(0,a.useState)("idle"),[m,f]=(0,a.useState)(null),p=(0,a.useCallback)(async()=>{if("live"!==g)try{f(null),_("connecting");let e=await navigator.mediaDevices.getUserMedia(n);r(e),c(!0),o(!1),_("live")}catch(e){console.error("[useVideoCall] Error accessing camera:",e),f(e instanceof DOMException?e.message:"No se pudo acceder a la c\xe1mara. Verifica los permisos del navegador."),_("idle")}},[g]),h=(0,a.useCallback)(()=>{e&&(e.getTracks().forEach(e=>e.stop()),r(null)),t&&(t.getTracks().forEach(e=>e.stop()),s(null)),c(!1),o(!1),d(!1),_("ended")},[e,t]),w=(0,a.useCallback)(()=>{if(!e)return;let r=!i;e.getAudioTracks().forEach(e=>{e.enabled=!r}),o(r)},[e,i]),y=(0,a.useCallback)(()=>{if(!e)return;let r=!l;e.getVideoTracks().forEach(e=>{e.enabled=r}),c(r)},[e,l]),b=(0,a.useCallback)(async()=>{if(u){t&&(t.getTracks().forEach(e=>e.stop()),s(null)),d(!1);return}try{let e=await navigator.mediaDevices.getDisplayMedia({video:!0,audio:!1});s(e),d(!0),e.getVideoTracks()[0].addEventListener("ended",()=>{s(null),d(!1)})}catch(e){console.warn("[useVideoCall] Screen sharing cancelled by user:",e),d(!1)}},[u,t]);return{localStream:e,screenStream:t,isMuted:i,isVideoEnabled:l,isScreenSharing:u,callStatus:g,cameraError:m,startCall:p,endCall:h,toggleAudio:w,toggleVideo:y,toggleScreenShare:b}}},4515:(e,r,t)=>{t.d(r,{X:()=>n});var a=t(1111);function n(){let[e,r]=(0,a.useState)({currentSession:null,sessionHistory:[],isLoading:!1,error:null}),t=(0,a.useMemo)(()=>({sessionId:"session-"+Date.now(),doctorId:"dr-garcia-001",doctorName:"Dr. Garc\xeda L\xf3pez",appointmentType:"telemedicina",startTime:new Date().toISOString(),status:"active"}),[]);(0,a.useEffect)(()=>{r(e=>({...e,isLoading:!0})),setTimeout(()=>{r(e=>({...e,currentSession:t,sessionHistory:[{sessionId:"session-001",doctorId:"dr-garcia-001",doctorName:"Dr. Garc\xeda L\xf3pez",appointmentType:"consulta",startTime:"2024-01-15T10:00:00Z",duration:30,status:"completed"},{sessionId:"session-002",doctorId:"dr-martinez-002",doctorName:"Dr. Mart\xednez Silva",appointmentType:"control",startTime:"2024-01-10T14:30:00Z",duration:20,status:"completed"}],isLoading:!1,error:null}))},1e3)},[t]);let n=async e=>{r(e=>({...e,isLoading:!0,error:null}));try{await new Promise(e=>setTimeout(e,500)),r(e=>({...e,currentSession:e.currentSession?{...e.currentSession,status:"active",startTime:new Date().toISOString()}:null,isLoading:!1}))}catch(e){r(e=>({...e,error:"Error al iniciar la sesi\xf3n",isLoading:!1}))}},s=async()=>{if(e.currentSession){r(e=>({...e,isLoading:!0,error:null}));try{await new Promise(e=>setTimeout(e,500));let t={...e.currentSession,status:"completed",duration:Math.floor((Date.now()-new Date(e.currentSession.startTime).getTime())/1e3/60)};r(e=>({...e,currentSession:null,sessionHistory:[t,...e.sessionHistory],isLoading:!1}))}catch(e){r(e=>({...e,error:"Error al finalizar la sesi\xf3n",isLoading:!1}))}}},i=()=>{if(!e.currentSession||"active"!==e.currentSession.status)return 0;let r=new Date(e.currentSession.startTime).getTime();return Math.floor((Date.now()-r)/1e3)},o=e=>{let r=null!=e?e:i(),t=Math.floor(r/60);return"".concat(t.toString().padStart(2,"0"),":").concat((r%60).toString().padStart(2,"0"))};return{...e,startSession:n,endSession:s,getSessionDuration:i,formatSessionDuration:o,hasActiveSession:()=>{var r;return(null==(r=e.currentSession)?void 0:r.status)==="active"},canStartSession:()=>e.currentSession&&"scheduled"===e.currentSession.status,formattedDuration:o()}}},7382:(e,r,t)=>{t.d(r,{V2:()=>s,nr:()=>o,yI:()=>i});var a=t(1111),n=t(438);function s(){let[e,r]=(0,a.useState)(null),[t,s]=(0,a.useState)([]),[i,o]=(0,a.useState)(null),[l,c]=(0,a.useState)(!0),[u,d]=(0,a.useState)(null),g=(0,a.useRef)(null);g.current||(g.current=(0,n.kT)());let _=g.current,m=(0,a.useCallback)(async()=>{if(_)try{c(!0),d(null);let{data:{user:e}}=await _.auth.getUser();if(!e)return void d("Usuario no autenticado");let{data:t,error:a}=await _.from("anamnesis").select("*").eq("patient_id",e.id).is("deleted_at",null).single();if(a&&"PGRST116"!==a.code)throw a;if(!t){r(null),s([]),o(null);return}r(t);let{data:n,error:i}=await _.from("anamnesis_sections").select("*").eq("anamnesis_id",t.id).order("section");if(i)throw i;s(n||[]);let l=(n||[]).filter(e=>e.completed),u=Math.floor(l.length/13*100);o({anamnesis_id:t.id,completion_percentage:u,completed_sections:l.map(e=>e.section),pending_sections:[],total_sections:13,estimated_time_remaining_minutes:(13-l.length)*5})}catch(e){console.error("Error fetching anamnesis:",e),d(e instanceof Error?e.message:"Error desconocido")}finally{c(!1)}},[_]),f=(0,a.useCallback)(async()=>{if(!_)return null;try{let{data:{user:e}}=await _.auth.getUser();if(!e)return d("Usuario no autenticado"),null;let r={patient_id:e.id,status:"in_progress",completion_percentage:0,sections_status:{}},{data:t,error:a}=await _.from("anamnesis").insert(r).select().single();if(a)throw a;return await m(),t}catch(e){return console.error("Error creating anamnesis:",e),d(e instanceof Error?e.message:"Error al crear anamnesis"),null}},[_,m]),p=(0,a.useCallback)(async r=>{if(!_)return!1;try{if(!e)return!1;let{error:t}=await _.from("anamnesis").update(r).eq("id",e.id);if(t)throw t;return await m(),!0}catch(e){return console.error("Error updating anamnesis:",e),d(e instanceof Error?e.message:"Error al actualizar anamnesis"),!1}},[e,_,m]),h=(0,a.useCallback)(async(r,a)=>{if(!_)return!1;try{if(!e)return!1;let{error:n}=await _.from("anamnesis_sections").upsert({anamnesis_id:e.id,section:r,data:a,completed:!0,last_modified:new Date().toISOString()},{onConflict:"anamnesis_id,section"});if(n)throw n;let s=t.filter(e=>e.completed).length+1,i=Math.floor(s/13*100);return await p({completion_percentage:i,last_updated_section:r,status:100===i?"completed":"in_progress"}),!0}catch(e){return console.error("Error updating section:",e),d(e instanceof Error?e.message:"Error al actualizar secci\xf3n"),!1}},[e,t,_,p]),w=(0,a.useCallback)(async()=>{await m()},[m]);return(0,a.useEffect)(()=>{m()},[m]),{anamnesis:e,sections:t,progress:i,loading:l,error:u,createAnamnesis:f,updateAnamnesis:p,updateSection:h,refreshAnamnesis:w}}function i(e){let[r,t]=(0,a.useState)(null),[s,i]=(0,a.useState)([]),[o,l]=(0,a.useState)([]),[c,u]=(0,a.useState)({video_enabled:!1,audio_enabled:!1,screen_sharing:!1,video_muted_by_user:!1,audio_muted_by_user:!1}),[d,g]=(0,a.useState)("good"),[_,m]=(0,a.useState)(!1),[f,p]=(0,a.useState)(null),h=(0,a.useRef)(null);h.current||(h.current=(0,n.kT)());let w=h.current,y=(0,a.useRef)(null),b=(0,a.useCallback)(async e=>{if(w)try{m(!0),p(null);let{data:r,error:a}=await w.from("telemedicine_sessions").select("*").eq("id",e).is("deleted_at",null).single();if(a)throw a;t(r);let{data:n,error:s}=await w.from("session_participants").select("*").eq("session_id",e).is("left_at",null);if(s)throw s;i(n||[]);let{data:o,error:c}=await w.from("session_events").select("*").eq("session_id",e).order("created_at",{ascending:!1}).limit(50);if(c)throw c;l(o||[])}catch(e){console.error("Error fetching session:",e),p(e instanceof Error?e.message:"Error desconocido")}finally{m(!1)}},[w]),E=(0,a.useCallback)(async(e,r)=>{if(!w)return null;try{var t;let{data:{user:a}}=await w.auth.getUser();if(!a)return p("Usuario no autenticado"),null;a.id;let n="room_".concat(Date.now(),"_").concat(Math.random().toString(36).substr(2,9)),{data:s,error:i}=await w.from("telemedicine_sessions").insert({appointment_id:e,patient_id:a.id,doctor_id:r,status:"scheduled",signaling_room_id:n,scheduled_start:new Date().toISOString(),connection_quality:"good",recording_enabled:!1,recording_consent_patient:!1,recording_consent_doctor:!1,metadata:{}}).select().single();if(i)throw i;let o={session_id:s.id,signaling_room_id:n,signaling_server_url:(null==(t=window.ENV)?void 0:t.NEXT_PUBLIC_SIGNALING_SERVER_URL)||"ws://localhost:8888",turn_servers:[],ice_servers:[{urls:["stun:stun.l.google.com:19302"]}]};return await b(s.id),o}catch(e){return console.error("Error starting session:",e),p(e instanceof Error?e.message:"Error al iniciar sesi\xf3n"),null}},[w,b]),S=(0,a.useCallback)(async()=>{if(!w)return!1;try{if(!r)return!1;y.current&&(y.current.getTracks().forEach(e=>e.stop()),y.current=null);let{error:e}=await w.from("telemedicine_sessions").update({status:"ended",actual_end:new Date().toISOString()}).eq("id",r.id);if(e)throw e;return await w.from("session_events").insert({session_id:r.id,event_type:"session_ended",details:"Session ended by user"}),await b(r.id),!0}catch(e){return console.error("Error ending session:",e),p(e instanceof Error?e.message:"Error al finalizar sesi\xf3n"),!1}},[r,w,b]),v=(0,a.useCallback)(async()=>{if(!w)return!1;try{if(!r)return!1;let e=!c.video_enabled;if(y.current){let r=y.current.getVideoTracks()[0];r&&(r.enabled=e)}return u(r=>({...r,video_enabled:e,video_muted_by_user:!e})),await w.from("session_events").insert({session_id:r.id,event_type:"video_toggled",details:e?"Video enabled":"Video disabled"}),!0}catch(e){return console.error("Error toggling video:",e),!1}},[r,c,w]),k=(0,a.useCallback)(async()=>{if(!w)return!1;try{if(!r)return!1;let e=!c.audio_enabled;if(y.current){let r=y.current.getAudioTracks()[0];r&&(r.enabled=e)}return u(r=>({...r,audio_enabled:e,audio_muted_by_user:!e})),await w.from("session_events").insert({session_id:r.id,event_type:"audio_toggled",details:e?"Audio enabled":"Audio disabled"}),!0}catch(e){return console.error("Error toggling audio:",e),!1}},[r,c,w]),C=(0,a.useCallback)(async()=>{if(!w)return!1;try{if(!r)return!1;let e=!c.screen_sharing;return u(r=>({...r,screen_sharing:e})),await w.from("session_events").insert({session_id:r.id,event_type:e?"screen_share_started":"screen_share_stopped",details:e?"Screen sharing started":"Screen sharing stopped"}),!0}catch(e){return console.error("Error toggling screen share:",e),!1}},[r,c,w]),T=(0,a.useCallback)(e=>{g(e),r&&w&&w.from("telemedicine_sessions").update({connection_quality:e}).eq("id",r.id).then(()=>{if("poor"===e||"disconnected"===e)return w.from("session_events").insert({session_id:r.id,event_type:"connection_issue",details:"Connection quality: ".concat(e)})}).catch(e=>console.error("Error updating connection quality:",e))},[r,w]),q=(0,a.useCallback)(async()=>{e&&await b(e)},[e,b]);return(0,a.useEffect)(()=>{e&&b(e)},[e,b]),(0,a.useEffect)(()=>{if(!e||!w)return;let r=w.channel("session_".concat(e)).on("postgres_changes",{event:"*",schema:"public",table:"session_participants",filter:"session_id=eq.".concat(e)},()=>{q()}).on("postgres_changes",{event:"INSERT",schema:"public",table:"session_events",filter:"session_id=eq.".concat(e)},e=>{l(r=>[e.new,...r])}).subscribe();return()=>{w.removeChannel(r)}},[e,w,q]),{session:r,participants:s,events:o,localMediaState:c,connectionQuality:d,loading:_,error:f,startSession:E,endSession:S,toggleVideo:v,toggleAudio:k,toggleScreenShare:C,updateConnectionQuality:T,refreshSession:q}}function o(){let[e,r]=(0,a.useState)([]),[t,s]=(0,a.useState)([]),[i,o]=(0,a.useState)([]),[l,c]=(0,a.useState)(!0),[u,d]=(0,a.useState)(null),g=(0,a.useRef)(null);g.current||(g.current=(0,n.kT)());let _=g.current,m=(0,a.useCallback)(async()=>{if(_)try{let{data:e,error:t}=await _.from("community_groups").select("*").is("deleted_at",null).order("member_count",{ascending:!1});if(t)throw t;r(e||[])}catch(e){console.error("Error fetching groups:",e),d(e instanceof Error?e.message:"Error al cargar grupos")}},[_]),f=(0,a.useCallback)(async()=>{if(_)try{let{data:{user:e}}=await _.auth.getUser();if(!e)return;let{data:r,error:t}=await _.from("group_memberships").select("group_id").eq("patient_id",e.id).eq("status","active");if(t)throw t;if(!r||0===r.length)return void s([]);let a=r.map(e=>e.group_id),{data:n,error:i}=await _.from("community_groups").select("*").in("id",a).is("deleted_at",null);if(i)throw i;s(n||[])}catch(e){console.error("Error fetching my groups:",e)}},[_]),p=(0,a.useCallback)(async e=>{if(!_)return!1;try{let{data:{user:r}}=await _.auth.getUser();if(!r)return d("Usuario no autenticado"),!1;let{error:t}=await _.from("group_memberships").insert({group_id:e,patient_id:r.id,role:"member",status:"active"});if(t)throw t;return await _.rpc("increment_group_member_count",{group_id:e}),await f(),await m(),!0}catch(e){return console.error("Error joining group:",e),d(e instanceof Error?e.message:"Error al unirse al grupo"),!1}},[_,f,m]),h=(0,a.useCallback)(async e=>{if(!_)return!1;try{let{data:{user:r}}=await _.auth.getUser();if(!r)return!1;let{error:t}=await _.from("group_memberships").delete().eq("group_id",e).eq("patient_id",r.id);if(t)throw t;return await _.rpc("decrement_group_member_count",{group_id:e}),await f(),await m(),!0}catch(e){return console.error("Error leaving group:",e),d(e instanceof Error?e.message:"Error al salir del grupo"),!1}},[_,f,m]),w=(0,a.useCallback)(async e=>{if(!_)return null;try{let{data:{user:r}}=await _.auth.getUser();if(!r)return d("Usuario no autenticado"),null;let{data:t,error:a}=await _.from("community_posts").insert({...e,author_id:r.id,moderation_status:"pending_review"}).select().single();if(a)throw a;return t}catch(e){return console.error("Error creating post:",e),d(e instanceof Error?e.message:"Error al crear publicaci\xf3n"),null}},[_]),y=(0,a.useCallback)(async e=>{if(!_)return null;try{let{data:{user:r}}=await _.auth.getUser();if(!r)return d("Usuario no autenticado"),null;let{data:t,error:a}=await _.from("post_comments").insert({...e,author_id:r.id,moderation_status:"approved"}).select().single();if(a)throw a;return t}catch(e){return console.error("Error adding comment:",e),d(e instanceof Error?e.message:"Error al agregar comentario"),null}},[_]),b=(0,a.useCallback)(async(e,r,t)=>{if(!_)return!1;try{let{data:{user:a}}=await _.auth.getUser();if(!a)return d("Usuario no autenticado"),!1;let{error:n}=await _.from("post_reactions").insert({post_id:r?null:e,comment_id:r,user_id:a.id,reaction_type:t});if(n)throw n;return!0}catch(e){return console.error("Error adding reaction:",e),d(e instanceof Error?e.message:"Error al agregar reacci\xf3n"),!1}},[_]),E=(0,a.useCallback)(async(e,r)=>{if(!_)return!1;try{let{data:{user:t}}=await _.auth.getUser();if(!t)return!1;let a=_.from("post_reactions").delete().eq("user_id",t.id);a=r?a.eq("comment_id",r):a.eq("post_id",e);let{error:n}=await a;if(n)throw n;return!0}catch(e){return console.error("Error removing reaction:",e),!1}},[_]),S=(0,a.useCallback)(async e=>{if(_)try{c(!0),d(null);let r=_.from("community_posts").select("*").eq("moderation_status","approved").is("deleted_at",null);(null==e?void 0:e.group_ids)&&e.group_ids.length>0&&(r=r.in("group_id",e.group_ids)),(null==e?void 0:e.tags)&&e.tags.length>0&&(r=r.contains("tags",e.tags));let t=(null==e?void 0:e.sort_by)||"recent";"recent"===t?r=r.order("created_at",{ascending:!1}):"popular"===t?r=r.order("reaction_count",{ascending:!1}):"trending"===t?r=r.order("last_activity_at",{ascending:!1}):"unanswered"===t&&(r=r.eq("comment_count",0).order("created_at",{ascending:!1})),r=r.limit(50);let{data:a,error:n}=await r;if(n)throw n;o(a||[])}catch(e){console.error("Error loading posts:",e),d(e instanceof Error?e.message:"Error al cargar publicaciones")}finally{c(!1)}},[_]),v=(0,a.useCallback)(async()=>{await Promise.all([m(),f()])},[m,f]);return(0,a.useEffect)(()=>{(async()=>{c(!0),await Promise.all([m(),f(),S()]),c(!1)})()},[m,f,S]),(0,a.useEffect)(()=>{let e=_.channel("community_posts").on("postgres_changes",{event:"INSERT",schema:"public",table:"community_posts",filter:"moderation_status=eq.approved"},e=>{o(r=>[e.new,...r])}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"community_posts"},e=>{o(r=>r.map(r=>r.id===e.new.id?e.new:r))}).subscribe();return()=>{_.removeChannel(e)}},[_]),{groups:e,myGroups:t,posts:i,loading:l,error:u,joinGroup:p,leaveGroup:h,createPost:w,addComment:y,addReaction:b,removeReaction:E,loadPosts:S,refreshGroups:v}}t(5320);var l=t(2613),c=t(983);(0,l.UU)(c.Y.supabase.url,c.Y.supabase.anonKey),t(3842),t(6220),t(4216),t(5129),t(811),t(4515)}}]);