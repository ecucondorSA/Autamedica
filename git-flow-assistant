#!/usr/bin/env bash
set -e

# git-flow-assistant: Asistente de Flujo Git para Autamedica
# Uso: ./git-flow-assistant

branch=$(git branch --show-current 2>/dev/null || echo "")
if [ -z "$branch" ]; then echo "âŒ No estÃ¡s en un repo git."; exit 1; fi

echo "ğŸš€ Autamedica â€“ Asistente de Flujo Git"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“ Rama actual: $branch"
echo "ğŸ“ Proyecto: $(pwd | grep -o '[^/]*$')"
echo ""
echo "ğŸ“‹ Estado actual:"
git status -s | head -10
echo ""

# Verificar si hay cambios staged
staged_count=$(git diff --cached --name-only | wc -l)
if [ "$staged_count" -eq 0 ]; then
    echo "âš ï¸  No hay cambios staged."
    echo "ğŸ”§ Opciones:"
    echo "   â€¢ git add .          (agregar todos los cambios)"
    echo "   â€¢ git add -p         (seleccionar cambios interactivamente)"
    echo "   â€¢ git add <archivo>  (agregar archivo especÃ­fico)"
    exit 0
fi

echo "âœ… Cambios staged: $staged_count archivo(s)"
echo ""

read -p "ğŸ¤– Â¿Commitear lo staged ahora? (Y/n): " do_commit
if [ "$do_commit" != "n" ] && [ "$do_commit" != "N" ]; then
    echo ""
    echo "ğŸ¯ Tipos de commit Autamedica:"
    echo "  âœ¨ nova feature  â†’ nueva funcionalidad completa"
    echo "  ğŸ› fix problema  â†’ correcciÃ³n de bug/error"
    echo "  âš™ï¸ ops tarea     â†’ infraestructura, CI/CD, dependencias"
    echo "  ğŸ“ docs          â†’ documentaciÃ³n, README, comments"
    echo "  ğŸ§¹ clean cÃ³digo  â†’ refactor, limpieza, organizaciÃ³n"
    echo "  âš¡ mejorias      â†’ optimizaciÃ³n de performance"
    echo "  ğŸ§ª tests         â†’ agregar/ajustar testing"
    echo ""

    read -p "ğŸ’¬ Tipo (copiÃ¡ emoji + tipo): " tipo
    read -p "ğŸ“ Mensaje breve: " msg

    if [ -z "$tipo" ] || [ -z "$msg" ]; then
        echo "âŒ Error: Tipo y mensaje son obligatorios"
        exit 1
    fi

    # Commit con formato estÃ¡ndar Autamedica
    git commit -m "$tipo: $msg

ğŸ¤– Generated with Autamedica Git Flow Assistant

Co-Authored-By: Claude <noreply@anthropic.com>"

    echo "âœ… Commit realizado: $tipo: $msg"
    echo ""
fi

# Flujo segÃºn rama actual
case "$branch" in
    feature/*|fix/*|hotfix/*)
        echo "ğŸŒŸ Rama de desarrollo detectada: $branch"
        echo ""

        if [[ "$branch" == hotfix/* ]]; then
            target_branch="main"
            echo "ğŸš¨ HOTFIX: PR directo a main"
        else
            target_branch="develop"
            echo "ğŸ”€ PR sugerido hacia: $target_branch"
        fi

        read -p "ğŸš€ Â¿Hacer push y abrir PR â†’ $target_branch? (Y/n): " ans
        if [ "$ans" != "n" ] && [ "$ans" != "N" ]; then
            echo "â¬†ï¸  Pushing branch..."
            git push -u origin "$branch"

            echo "ğŸ“ Creando PR..."
            if command -v gh >/dev/null 2>&1; then
                gh pr create --base "$target_branch" --title "$branch" --body "**Tipo**: $(echo $branch | cut -d'/' -f1)
**DescripciÃ³n**: $branch

**Checklist**:
- [ ] Build passing
- [ ] Tests passing
- [ ] Code review completed
- [ ] No breaking changes
- [ ] Documentation updated

**Deploy**:
- Target: $target_branch
- Preview: Cloudflare Pages automÃ¡tico"

                echo ""
                echo "ğŸ¯ PR creado exitosamente"
                read -p "ğŸŒ Â¿Abrir PR en browser? (Y/n): " open_pr
                if [ "$open_pr" != "n" ] && [ "$open_pr" != "N" ]; then
                    gh pr view --web
                fi

                echo ""
                echo "ğŸ¤– Sugerencias de RevisiÃ³n por IA:"
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo "Claude Code Review:"
                echo "\"RevisÃ¡ este diff con foco en seguridad, performance y legibilidad. SeÃ±alÃ¡ riesgos y fixes rÃ¡pidos.\""
                echo ""
                echo "ChatGPT5 Checklist:"
                echo "\"ValidÃ¡ que el PR cumpla: build OK, rutas crÃ­ticas no rotas, naming consistente, sin secretos, historias de usuario cubiertas.\""
            else
                echo "âš ï¸  GitHub CLI no instalado. Comandos manuales:"
                echo "   git push -u origin $branch"
                echo "   gh pr create --base $target_branch --title '$branch'"
            fi
        fi

        if [[ "$branch" == hotfix/* ]]; then
            echo ""
            echo "ğŸ”„ IMPORTANTE: DespuÃ©s del merge a main, ejecutar:"
            echo "   git checkout staging && git pull && git merge origin/main && git push"
            echo "   git checkout develop && git pull && git merge origin/main && git push"
        fi
        ;;

    develop)
        echo "ğŸ”§ Rama de desarrollo principal: develop"
        echo "âœ… Commits directos permitidos aquÃ­"
        echo ""
        read -p "ğŸ¯ Â¿Promover develop â†’ staging (QA) con PR? (y/N): " ans
        if [ "$ans" = "y" ] || [ "$ans" = "Y" ]; then
            if command -v gh >/dev/null 2>&1; then
                gh pr create --base staging --title "ğŸš€ Promote develop â†’ staging (QA)" --body "**QA Release**

**Cambios incluidos**:
$(git log --oneline staging..develop | head -10)

**Testing**:
- [ ] Manual QA completed
- [ ] Automated tests passing
- [ ] Performance validated
- [ ] Cross-browser tested

**Deploy**: Staging environment (Cloudflare Pages Preview)"

                echo "âœ… PR develop â†’ staging creado"
                gh pr view --web
            else
                echo "âš ï¸  Instala GitHub CLI: gh pr create --base staging"
            fi
        fi
        ;;

    staging)
        echo "âš ï¸  Rama de staging (QA)"
        echo "ğŸš¨ EvitÃ¡ commits directos en staging"
        echo "ğŸ’¡ Usa PRs desde develop para cambios"
        echo ""
        read -p "ğŸš€ Â¿Promover staging â†’ main (PRODUCCIÃ“N)? (y/N): " ans
        if [ "$ans" = "y" ] || [ "$ans" = "Y" ]; then
            if command -v gh >/dev/null 2>&1; then
                gh pr create --base main --title "ğŸ‰ Release: staging â†’ main (PRODUCCIÃ“N)" --body "**PRODUCTION RELEASE**

**Release Notes**:
$(git log --oneline main..staging | head -15)

**Pre-deployment Checklist**:
- [ ] QA sign-off complete
- [ ] Performance benchmarks passed
- [ ] Security scan completed
- [ ] Database migrations tested
- [ ] Rollback plan prepared
- [ ] Monitoring alerts configured

**Deploy**: Production (Cloudflare Pages main branch)
**Impact**: All users"

                echo "ğŸ‰ PR staging â†’ main (PRODUCCIÃ“N) creado"
                gh pr view --web
            else
                echo "âš ï¸  Instala GitHub CLI para PR automÃ¡tico"
            fi
        fi
        ;;

    main)
        echo "ğŸš¨ Rama de producciÃ³n (main)"
        echo "â›” Solo HOTFIXES permitidos aquÃ­"
        echo ""
        read -p "ğŸ†˜ Â¿Crear hotfix/<slug> desde main? (y/N): " ans
        if [ "$ans" = "y" ] || [ "$ans" = "Y" ]; then
            read -p "ğŸ·ï¸  Slug del hotfix (ej: fix-auth-bug): " slug
            if [ -n "$slug" ]; then
                git checkout -b "hotfix/$slug"
                echo "ğŸŒ¿ Rama hotfix/$slug creada desde main"
                echo "ğŸ“Œ HacÃ© tus cambios, luego ejecutÃ¡ este asistente otra vez"
                echo ""
                echo "ğŸ”„ Flujo hotfix:"
                echo "   1. Commit en hotfix/$slug"
                echo "   2. PR hotfix/$slug â†’ main"
                echo "   3. Merge a main (deploy inmediato)"
                echo "   4. Back-merge main â†’ staging â†’ develop"
            fi
        fi
        ;;

    *)
        echo "â„¹ï¸  Rama personalizada: $branch"
        echo "ğŸ“‹ Flujo recomendado:"
        echo "   â€¢ feature/<nombre> - nueva funcionalidad"
        echo "   â€¢ fix/<nombre>     - correcciÃ³n de bug"
        echo "   â€¢ hotfix/<nombre>  - fix urgente desde main"
        echo "   â€¢ develop          - integraciÃ³n de desarrollo"
        echo "   â€¢ staging          - QA y validaciÃ³n"
        echo "   â€¢ main             - producciÃ³n"
        ;;
esac

echo ""
echo "ğŸ§­ Deployment Config (Cloudflare Pages):"
echo "   ğŸ“ main branch    â†’ PRODUCCIÃ“N (autamedica-*.pages.dev)"
echo "   ğŸ“ staging branch â†’ PREVIEW QA"
echo "   ğŸ“ develop branch â†’ PREVIEW DEV"
echo "   ğŸ“ PR branches    â†’ PREVIEW efÃ­mero"
echo ""
echo "ğŸ¯ PrÃ³ximos comandos Ãºtiles:"
echo "   ./git-flow-assistant  (ejecutar otra vez)"
echo "   git status           (ver estado)"
echo "   git log --oneline    (ver commits recientes)"