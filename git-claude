#!/bin/bash

# git-claude: Asistente Git inteligente para Autamedica con Claude Opus 4.1
# Uso: ./git-claude (despuÃ©s de git add .)

echo "ğŸ¤– Claude Opus 4.1 - Autamedica Git Assistant"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“ Rama actual: $(git branch --show-current)"
echo "ğŸ“ Proyecto: Autamedica ($(pwd | grep -o '[^/]*$'))"
echo ""

# Verificar si hay cambios staged
if ! git diff --cached --quiet; then
    echo "ğŸ“‹ Cambios detectados para commit:"
    git diff --cached --name-only | sed 's/^/   â€¢ /'
    echo ""
else
    echo "âš ï¸  No hay cambios staged. Ejecuta 'git add .' primero."
    exit 1
fi

# Verificar rama y advertir si es crÃ­tica
branch=$(git branch --show-current)
if [[ "$branch" == "main" ]] || [[ "$branch" == "staging" ]]; then
    echo "ğŸš¨ ADVERTENCIA: EstÃ¡s en rama '$branch'"
    echo "   â†’ En producciÃ³n se recomiendan PR/Merge, no commits directos"
    echo "   â†’ Â¿EstÃ¡s seguro de continuar?"
    read -p "   Continuar? (y/N): " continue_anyway
    if [[ "$continue_anyway" != "y" ]]; then
        echo "âŒ OperaciÃ³n cancelada"
        exit 1
    fi
    echo ""
fi

echo "ğŸ¯ Autamedica Commit Types:"
echo "  âœ¨  nova feature  â†’ nueva funcionalidad completa"
echo "  ğŸ›  fix problema  â†’ correcciÃ³n de bug/error"
echo "  âš™ï¸  ops tarea     â†’ infraestructura, CI/CD, dependencias"
echo "  ğŸ“  docs          â†’ documentaciÃ³n, README, comments"
echo "  ğŸ§¹  clean cÃ³digo  â†’ refactor, limpieza, organizaciÃ³n"
echo "  âš¡  mejorias      â†’ optimizaciÃ³n de performance"
echo "  ğŸ§ª  tests         â†’ agregar/ajustar testing"
echo ""

# Input del tipo de commit
read -p "ğŸ’¬ Selecciona emoji + tipo (ej: âœ¨nova feature): " commit_type
read -p "ğŸ“ Describe el cambio brevemente: " commit_message

# Validar que no estÃ© vacÃ­o
if [[ -z "$commit_type" ]] || [[ -z "$commit_message" ]]; then
    echo "âŒ Error: Tipo y mensaje son obligatorios"
    exit 1
fi

# Generar commit completo
full_commit="$commit_type: $commit_message

ğŸ¤– Generated with [Claude Opus 4.1](https://claude.ai/code)

Co-Authored-By: Claude <noreply@anthropic.com>"

echo ""
echo "ğŸ¯ Commit generado:"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "$full_commit"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

read -p "ğŸš€ Â¿Ejecutar commit? (Y/n): " confirm

if [[ "$confirm" == "n" ]] || [[ "$confirm" == "N" ]]; then
    echo "âŒ Commit cancelado"
    exit 1
fi

# Ejecutar commit usando HEREDOC para formato correcto
git commit -m "$(cat <<EOF
$full_commit
EOF
)"

if [ $? -eq 0 ]; then
    echo ""
    echo "âœ… Commit realizado exitosamente"
    echo "ğŸ“Š Estado actual:"
    git log --oneline -1
    echo ""
    echo "ğŸš€ PrÃ³ximos pasos sugeridos:"
    echo "   â€¢ git push (para enviar a remoto)"
    echo "   â€¢ git status (verificar estado)"
    echo "   â€¢ ./git-claude (para prÃ³ximo commit)"
else
    echo ""
    echo "âŒ Error en el commit. Verifica los cambios."
fi