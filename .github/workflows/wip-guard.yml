name: 'WIP Guard'

on:
  pull_request:
    types: [opened, edited, synchronize]
    branches: [ main, staging, develop ]

permissions:
  contents: read
  pull-requests: write

jobs:
  wip-check:
    name: 'Verificar estado WIP/Draft'
    runs-on: ubuntu-latest

    steps:
      - name: Check for WIP/Draft indicators
        uses: actions/github-script@v7
        with:
          script: |
            const title = context.payload.pull_request.title.toLowerCase();
            const isDraft = context.payload.pull_request.draft;

            const wipPatterns = [
              'wip', 'work in progress', 'draft', 'todo', 'fixme',
              'temp', 'temporary', 'hack', 'quick fix', 'hotfix',
              'debug', 'test', 'testing', 'experimental',
              'do not merge', 'dnm', 'broken'
            ];

            const foundWip = wipPatterns.some(pattern => title.includes(pattern));

            if (isDraft) {
              console.log('✅ PR is marked as draft - this is correct for WIP');
              return;
            }

            if (foundWip) {
              const comment = `## 🚧 WIP/Draft Detected

              This PR contains WIP indicators in the title but is not marked as draft.

              **🔍 Found indicators:**
              - Title: "${context.payload.pull_request.title}"

              **📋 Please:**
              1. Mark this PR as draft if it's still work in progress
              2. Remove WIP indicators from title if it's ready for review
              3. Ensure all TODO/FIXME comments are addressed

              **🚨 This PR will be blocked from merging until resolved.**

              ---
              *Auto-generated by WIP Guard workflow*`;

              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });

              core.setFailed('PR contains WIP indicators but is not marked as draft');
            } else {
              console.log('✅ No WIP indicators found - PR appears ready for review');
            }