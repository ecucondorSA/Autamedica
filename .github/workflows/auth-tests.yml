name: ğŸ” Auth Tests

# Ejecutar en PRs y pushes a main/develop
on:
  push:
    branches: [main, develop]
    paths:
      - 'apps/web-app/**'
      - 'apps/auth/**'
      - 'apps/patients/**'
      - 'apps/doctors/**'
      - 'packages/auth/**'
      - 'packages/types/**'
      - 'tests/integration/**'
  pull_request:
    paths:
      - 'apps/web-app/**'
      - 'apps/auth/**'
      - 'apps/patients/**'
      - 'apps/doctors/**'
      - 'packages/auth/**'
      - 'packages/types/**'
      - 'tests/integration/**'
  workflow_dispatch: # Permitir ejecuciÃ³n manual

jobs:
  auth-tests-quick:
    name: ğŸš€ Tests RÃ¡pidos de AutenticaciÃ³n
    runs-on: ubuntu-latest
    timeout-minutes: 15

    env:
      NODE_OPTIONS: --max-old-space-size=4096
      CI: true
      # Variables de entorno para Supabase (desde secrets)
      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.2

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: ğŸ“š Install dependencias
        run: pnpm install --frozen-lockfile

      - name: ğŸ—ï¸ Build packages
        run: |
          # Build in explicit order to ensure .d.ts files exist before dependent packages build
          echo "ğŸ“¦ Building @autamedica/types..."
          pnpm --filter @autamedica/types build
          ls -la packages/types/dist/index.d.ts

          echo "ğŸ“¦ Building @autamedica/utils..."
          pnpm --filter @autamedica/utils build

          echo "ğŸ“¦ Building @autamedica/shared..."
          pnpm --filter @autamedica/shared build
          ls -la packages/shared/dist/index.d.ts

          echo "ğŸ“¦ Building @autamedica/auth..."
          pnpm --filter @autamedica/auth build

          echo "ğŸ“¦ Building @autamedica/hooks..."
          pnpm --filter @autamedica/hooks build

          echo "ğŸ“¦ Building @autamedica/tailwind-config..."
          pnpm --filter @autamedica/tailwind-config build

          echo "ğŸ“¦ Building @autamedica/telemedicine..."
          pnpm --filter @autamedica/telemedicine build

          echo "ğŸ“¦ Building @autamedica/ui..."
          pnpm --filter @autamedica/ui build

      - name: ğŸ­ Install Playwright browsers
        run: pnpm exec playwright install chromium --with-deps

      - name: ğŸš€ Start dev servers (background)
        run: |
          echo "ğŸŒ Starting auth server (port 3000)..."
          cd apps/web-app && pnpm dev &
          echo $! > /tmp/web-app.pid

          echo "ğŸ‘¤ Starting patients server (port 3003)..."
          cd apps/patients && pnpm dev &
          echo $! > /tmp/patients.pid

          echo "ğŸ‘¨â€âš•ï¸ Starting doctors server (port 3002)..."
          cd apps/doctors && pnpm dev &
          echo $! > /tmp/doctors.pid

          echo "â³ Waiting for servers to start..."
          sleep 45

          echo "ğŸ” Checking server health..."
          curl -f http://localhost:3000 || echo "âš ï¸  Web-app not responding"
          curl -f http://localhost:3003 || echo "âš ï¸  Patients app not responding"
          curl -f http://localhost:3002 || echo "âš ï¸  Doctors app not responding"

      - name: ğŸ§ª Run auth tests (headless)
        run: pnpm test:auth:ci
        timeout-minutes: 10

      - name: ğŸ“¸ Upload test screenshots (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-screenshots-quick
          path: test-results/screenshots/
          retention-days: 7

      - name: ğŸ›‘ Stop dev servers
        if: always()
        run: |
          [ -f /tmp/web-app.pid ] && kill $(cat /tmp/web-app.pid) || true
          [ -f /tmp/patients.pid ] && kill $(cat /tmp/patients.pid) || true
          [ -f /tmp/doctors.pid ] && kill $(cat /tmp/doctors.pid) || true

  auth-tests-extensive:
    name: ğŸ”¬ Tests Extensivos de AutenticaciÃ³n
    runs-on: ubuntu-latest
    timeout-minutes: 30
    # Solo en merges a main o manual
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'

    env:
      NODE_OPTIONS: --max-old-space-size=4096
      CI: true
      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.2

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: ğŸ“š Install dependencias
        run: pnpm install --frozen-lockfile

      - name: ğŸ—ï¸ Build packages
        run: |
          # Build in explicit order to ensure .d.ts files exist before dependent packages build
          echo "ğŸ“¦ Building @autamedica/types..."
          pnpm --filter @autamedica/types build
          ls -la packages/types/dist/index.d.ts

          echo "ğŸ“¦ Building @autamedica/utils..."
          pnpm --filter @autamedica/utils build

          echo "ğŸ“¦ Building @autamedica/shared..."
          pnpm --filter @autamedica/shared build
          ls -la packages/shared/dist/index.d.ts

          echo "ğŸ“¦ Building @autamedica/auth..."
          pnpm --filter @autamedica/auth build

          echo "ğŸ“¦ Building @autamedica/hooks..."
          pnpm --filter @autamedica/hooks build

          echo "ğŸ“¦ Building @autamedica/tailwind-config..."
          pnpm --filter @autamedica/tailwind-config build

          echo "ğŸ“¦ Building @autamedica/telemedicine..."
          pnpm --filter @autamedica/telemedicine build

          echo "ğŸ“¦ Building @autamedica/ui..."
          pnpm --filter @autamedica/ui build

      - name: ğŸ­ Install Playwright browsers
        run: pnpm exec playwright install chromium --with-deps

      - name: ğŸš€ Start dev servers (background)
        run: |
          echo "ğŸŒ Starting auth server (port 3000)..."
          cd apps/web-app && pnpm dev &
          echo $! > /tmp/web-app.pid

          echo "ğŸ‘¤ Starting patients server (port 3003)..."
          cd apps/patients && pnpm dev &
          echo $! > /tmp/patients.pid

          echo "ğŸ‘¨â€âš•ï¸ Starting doctors server (port 3002)..."
          cd apps/doctors && pnpm dev &
          echo $! > /tmp/doctors.pid

          echo "ğŸ¢ Starting companies server (port 3004)..."
          cd apps/companies && pnpm dev &
          echo $! > /tmp/companies.pid

          echo "âš™ï¸ Starting admin server (port 3005)..."
          cd apps/admin && pnpm dev &
          echo $! > /tmp/admin.pid

          echo "â³ Waiting for servers to start..."
          sleep 60

          echo "ğŸ” Checking server health..."
          curl -f http://localhost:3000 || echo "âš ï¸  Web-app not responding"
          curl -f http://localhost:3003 || echo "âš ï¸  Patients app not responding"
          curl -f http://localhost:3002 || echo "âš ï¸  Doctors app not responding"
          curl -f http://localhost:3004 || echo "âš ï¸  Companies app not responding"
          curl -f http://localhost:3005 || echo "âš ï¸  Admin app not responding"

      - name: ğŸ”¬ Run extensive auth tests (headless)
        run: |
          # Crear directorio para screenshots
          mkdir -p test-results/screenshots

          # Ejecutar tests extensivos en modo headless
          pnpm exec vitest run tests/integration/auth-extensive.browser.test.ts \
            --config vitest.browser.config.ts \
            --browser.headless=true \
            --reporter=verbose
        timeout-minutes: 20

      - name: ğŸ“¸ Upload test screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-screenshots-extensive
          path: test-results/screenshots/
          retention-days: 30

      - name: ğŸ“Š Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-extensive
          path: test-results/
          retention-days: 30

      - name: ğŸ›‘ Stop dev servers
        if: always()
        run: |
          [ -f /tmp/web-app.pid ] && kill $(cat /tmp/web-app.pid) || true
          [ -f /tmp/patients.pid ] && kill $(cat /tmp/patients.pid) || true
          [ -f /tmp/doctors.pid ] && kill $(cat /tmp/doctors.pid) || true
          [ -f /tmp/companies.pid ] && kill $(cat /tmp/companies.pid) || true
          [ -f /tmp/admin.pid ] && kill $(cat /tmp/admin.pid) || true

      - name: ğŸ’¬ Comment on PR with results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const comment = `## ğŸ”¬ Tests Extensivos de AutenticaciÃ³n

            âœ… Tests completados

            ğŸ“¸ Screenshots disponibles en artifacts
            ğŸ“Š Resultados detallados en artifacts

            ### Tests Ejecutados:
            - âœ… Complete Patient Journey (11 fases)
            - âœ… Cross-App Protection Journey (7 fases)
            - âœ… ReturnUrl Journey (4 fases)
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
