name: "AI Review (Claude)"

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]

permissions:
  contents: read
  pull-requests: write

jobs:
  review:
    if: ${{ !github.event.pull_request.draft }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get diff
        run: |
          echo "ðŸ” Obteniendo diff del PR..."
          git fetch origin ${{ github.base_ref }} --depth=1
          git diff --unified=3 origin/${{ github.base_ref }}...HEAD > pr.diff

          # Debug: show diff size
          echo "ðŸ“Š TamaÃ±o del diff: $(wc -l < pr.diff) lÃ­neas"
          head -20 pr.diff

      - name: Ask Claude for Review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          if [ -z "$ANTHROPIC_API_KEY" ]; then
            echo "âš ï¸  ANTHROPIC_API_KEY no configurado - omitiendo revisiÃ³n Claude"
            echo "Sin revisiÃ³n Claude disponible." > review.md
            exit 0
          fi

          echo "ðŸ¤– Solicitando revisiÃ³n a Claude..."

          # Prepare prompt for medical software context
          prompt="ActuÃ¡ como revisor senior de AutaMedica (healthtech, HIPAA-compliant).

          Contexto: AutaMedica es una plataforma mÃ©dica con:
          - 4 apps especializadas (web-app, doctors, patients, companies)
          - Packages crÃ­ticos (@autamedica/types, auth, shared, hooks)
          - Compliance HIPAA obligatorio
          - Sistema de contratos TypeScript estricto

          RevisÃ¡ este diff con foco crÃ­tico en:

          ðŸ”’ SEGURIDAD MÃ‰DICA:
          - Datos mÃ©dicos (PHI/PII) expuestos en logs o cÃ³digo
          - Secrets hardcodeados o variables de entorno inseguras
          - ValidaciÃ³n de inputs mÃ©dicos (patient ID, medical records)
          - Headers de seguridad HIPAA

          ðŸ“‹ CONTRATOS Y TYPES:
          - Breaking changes en @autamedica/types
          - Exports nuevos documentados en GLOSARIO_MAESTRO.md
          - Consistencia con branded types (PatientId, DoctorId)
          - APIResponse<T> discriminated unions

          âš¡ PERFORMANCE Y UX:
          - Bundle size impact (lÃ­mites configurados en .size-limit.json)
          - Async/await patterns correctos
          - Accesibilidad para software mÃ©dico
          - Responsive design para tablets mÃ©dicos

          ðŸ—ï¸ ARQUITECTURA:
          - Apps no importan entre sÃ­ (solo packages compartidos)
          - No deep imports (@autamedica/*/src/*)
          - Violaciones de boundaries (ESLint rules)

          RespondÃ© en Markdown con:

          ## ðŸš¨ Riesgos CrÃ­ticos (Bloqueantes)
          [Lista de issues que deben arreglarse antes del merge]

          ## ðŸ’¡ Recomendaciones (Mejoras)
          [Sugerencias con ejemplos de cÃ³digo especÃ­ficos]

          ## âœ… Checklist de VerificaciÃ³n
          - [ ] Datos mÃ©dicos protegidos (no logs, no hardcode)
          - [ ] HTTPS y headers de seguridad configurados
          - [ ] Types documentados en glosario maestro
          - [ ] Performance dentro de lÃ­mites bundle
          - [ ] Accesibilidad mÃ©dica (WCAG 2.1 AA)
          - [ ] Tests unitarios para nueva funcionalidad

          ## ðŸ“Š Puntaje de Confianza
          **Score**: X/100
          **RecomendaciÃ³n**: âœ… APPROVE / âš ï¸  NEEDS_WORK / âŒ REQUEST_CHANGES"

          # Prepare diff content (escape for JSON)
          diff_content=$(jq -Rs '.' pr.diff)

          # Call Claude API
          response=$(curl -s https://api.anthropic.com/v1/messages \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -H "content-type: application/json" \
            -d "{
              \"model\": \"claude-3-5-sonnet-20241022\",
              \"max_tokens\": 2000,
              \"temperature\": 0.1,
              \"messages\": [
                {
                  \"role\": \"user\",
                  \"content\": $(echo "$prompt" | jq -Rs '.')
                },
                {
                  \"role\": \"user\",
                  \"content\": $diff_content
                }
              ]
            }")

          # Extract content from response
          if echo "$response" | jq -e '.content[0].text' >/dev/null 2>&1; then
            echo "$response" | jq -r '.content[0].text' > review.md
            echo "âœ… RevisiÃ³n Claude completada"
          else
            echo "âŒ Error en respuesta de Claude:"
            echo "$response" | jq '.'
            echo "Error obteniendo revisiÃ³n de Claude. Verificar API key y lÃ­mites." > review.md
          fi

      - name: Comment Claude Review on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let body = '';

            try {
              body = fs.readFileSync('review.md', 'utf8');
            } catch (error) {
              body = 'âŒ Error: No se pudo obtener la revisiÃ³n de Claude.';
            }

            const fullComment = `## ðŸ¤– RevisiÃ³n AI - Claude

            ${body}

            ---
            *RevisiÃ³n automÃ¡tica generada por Claude 3.5 Sonnet - ${new Date().toISOString()}*`;

            // Find existing Claude review comment
            const { data: comments } = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const existingComment = comments.find(c =>
              c.body.includes('ðŸ¤– RevisiÃ³n AI - Claude')
            );

            if (existingComment) {
              await github.rest.issues.updateComment({
                comment_id: existingComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: fullComment
              });
              console.log('âœ… Comentario Claude actualizado');
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: fullComment
              });
              console.log('âœ… Comentario Claude creado');
            }