name: 'Secrets Scan'

on:
  push:
    branches: [ main, staging, develop ]
  pull_request:
    branches: [ main, staging, develop ]

permissions:
  contents: read
  security-events: write

jobs:
  gitleaks:
    name: 'GitLeaks - Detecci√≥n de secretos'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run GitLeaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  trufflehog:
    name: 'TruffleHog - Verificaci√≥n adicional'
    runs-on: ubuntu-latest
    # Solo ejecutar en PRs (TruffleHog requiere base != head)
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.pull_request.base.sha }}
          head: ${{ github.event.pull_request.head.sha }}
          extra_args: --debug --only-verified

  custom-patterns:
    name: 'Patrones personalizados m√©dicos'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Scan for medical data patterns
        run: |
          echo "üîç Buscando patrones de datos m√©dicos sensibles..."

          # Patrones de datos m√©dicos que NO deber√≠an estar en c√≥digo
          MEDICAL_PATTERNS=(
            "patient_id.*[0-9]{6,}"
            "medical_record.*[0-9]{6,}"
            "ssn.*[0-9]{3}-[0-9]{2}-[0-9]{4}"
            "npi.*[0-9]{10}"
            "hipaa.*key"
            "phi_.*"
            "medical_key.*"
          )

          FOUND_ISSUES=false

          for pattern in "${MEDICAL_PATTERNS[@]}"; do
            echo "Checking pattern: $pattern"
            if grep -r -i "$pattern" --exclude-dir=node_modules --exclude-dir=.git --exclude="*.lock" . ; then
              echo "‚ùå FOUND POTENTIAL MEDICAL DATA LEAK: $pattern"
              FOUND_ISSUES=true
            fi
          done

          if [ "$FOUND_ISSUES" = true ]; then
            echo "üö® CRITICAL: Potential medical data found in code"
            echo "This could violate HIPAA compliance"
            exit 1
          else
            echo "‚úÖ No medical data patterns detected"
          fi