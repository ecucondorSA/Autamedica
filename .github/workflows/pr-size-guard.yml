name: 'PR Size Guard'

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  size-check:
    name: 'Verificar tamaÃ±o del PR'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verificar tamaÃ±o del PR
        uses: actions/github-script@v7
        with:
          script: |
            const MAX_LINES = 1200;
            const MAX_FILES = 50;

            // Obtener archivos del PR
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });

            const totalChanges = files.reduce((sum, file) => sum + file.changes, 0);
            const totalFiles = files.length;

            console.log(`PR Stats: ${totalChanges} lÃ­neas cambiadas, ${totalFiles} archivos`);

            let status = 'success';
            let message = 'âœ… PR size is appropriate';

            if (totalChanges > MAX_LINES || totalFiles > MAX_FILES) {
              status = 'failure';
              message = `âŒ PR too large: ${totalChanges} lÃ­neas (mÃ¡x ${MAX_LINES}), ${totalFiles} archivos (mÃ¡x ${MAX_FILES})`;

              // Comentar en el PR
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## ğŸš¨ PR Size Warning

**Este PR es demasiado grande para review efectivo.**

ğŸ“Š **EstadÃ­sticas actuales:**
- **LÃ­neas cambiadas**: ${totalChanges} (mÃ¡ximo recomendado: ${MAX_LINES})
- **Archivos modificados**: ${totalFiles} (mÃ¡ximo recomendado: ${MAX_FILES})

### ğŸ’¡ **Recomendaciones:**

1. **Dividir en PRs mÃ¡s pequeÃ±os** - Facilita el review y reduce errores
2. **Usar feature flags** - Para releases incrementales
3. **Separar refactoring** - De nuevas features
4. **Agrupar por dominio** - Un PR por Ã¡rea funcional

### ğŸ“‹ **Excepciones VÃ¡lidas:**

Si este PR tiene una razÃ³n vÃ¡lida para ser grande, agrega una justificaciÃ³n en la descripciÃ³n:
- [ ] MigraciÃ³n de dependencias
- [ ] Refactoring arquitectural necesario
- [ ] GeneraciÃ³n automÃ¡tica de cÃ³digo
- [ ] SincronizaciÃ³n con rama externa

**ğŸ¯ Objetivo:** PRs pequeÃ±os = reviews mÃ¡s rÃ¡pidos y cÃ³digo mÃ¡s confiable`
              });
            }

            // Establecer status check
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.payload.pull_request.head.sha,
              state: status,
              context: 'pr-size-guard',
              description: message
            });

            if (status === 'failure') {
              core.setFailed(message);
            }