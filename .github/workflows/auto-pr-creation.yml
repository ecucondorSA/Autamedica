name: ðŸ”€ Auto PR Creation

on:
  push:
    branches:
      - 'feat/**'
      - 'fix/**'
      - 'chore/**'
      - 'docs/**'
      - 'refactor/**'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  create-pr:
    name: Create PR AutomÃ¡tico
    runs-on: ubuntu-latest

    # Solo correr si no es un auto-commit
    if: "!contains(github.event.head_commit.message, 'auto-commit')"

    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” Verificar si PR existe
        id: check_pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH=${GITHUB_REF##*/}

          # Buscar PR existente
          EXISTING_PR=$(gh pr list \
            --head "$BRANCH" \
            --json number \
            --jq '.[0].number' || echo "")

          if [ -n "$EXISTING_PR" ]; then
            echo "pr_exists=true" >> $GITHUB_OUTPUT
            echo "pr_number=$EXISTING_PR" >> $GITHUB_OUTPUT
            echo "âœ… PR #$EXISTING_PR ya existe para branch $BRANCH"
          else
            echo "pr_exists=false" >> $GITHUB_OUTPUT
            echo "ðŸ“ No existe PR para branch $BRANCH"
          fi

          echo "branch=$BRANCH" >> $GITHUB_OUTPUT

      - name: ðŸ“Š Generar informaciÃ³n del PR
        if: steps.check_pr.outputs.pr_exists == 'false'
        id: pr_info
        run: |
          BRANCH="${{ steps.check_pr.outputs.branch }}"

          # TÃ­tulo desde Ãºltimo commit
          TITLE=$(git log -1 --pretty=%s)

          # Determinar tipo de PR desde branch name
          if [[ "$BRANCH" == feat/* ]]; then
            PR_TYPE="âœ¨ Feature"
            LABEL="enhancement"
          elif [[ "$BRANCH" == fix/* ]]; then
            PR_TYPE="ðŸ› Bug Fix"
            LABEL="bug"
          elif [[ "$BRANCH" == chore/* ]]; then
            PR_TYPE="ðŸ”§ Chore"
            LABEL="maintenance"
          elif [[ "$BRANCH" == docs/* ]]; then
            PR_TYPE="ðŸ“š Documentation"
            LABEL="documentation"
          elif [[ "$BRANCH" == refactor/* ]]; then
            PR_TYPE="â™»ï¸ Refactor"
            LABEL="refactor"
          else
            PR_TYPE="ðŸ”„ Update"
            LABEL="auto-generated"
          fi

          echo "pr_type=$PR_TYPE" >> $GITHUB_OUTPUT
          echo "label=$LABEL" >> $GITHUB_OUTPUT
          echo "title=$TITLE" >> $GITHUB_OUTPUT

      - name: ðŸš€ Crear PR
        if: steps.check_pr.outputs.pr_exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="${{ steps.check_pr.outputs.branch }}"
          TITLE="${{ steps.pr_info.outputs.title }}"
          PR_TYPE="${{ steps.pr_info.outputs.pr_type }}"
          LABEL="${{ steps.pr_info.outputs.label }}"

          # Generar lista de commits
          COMMITS=$(git log origin/main..HEAD \
            --pretty=format:"- %s (%h)" \
            --max-count=20 || echo "- Initial commit")

          # Generar lista de archivos modificados
          FILES=$(git diff --name-status origin/main..HEAD \
            --diff-filter=ADMR \
            | head -30 || echo "No files")

          # Crear body del PR
          cat > /tmp/pr-body.md <<EOF
          ## $PR_TYPE

          ### ðŸ“ DescripciÃ³n

          $TITLE

          ### ðŸ“‹ Commits incluidos

          $COMMITS

          ### ðŸ“‚ Archivos modificados

          \`\`\`
          $FILES
          \`\`\`

          ### âœ… Checklist

          - [ ] CÃ³digo revisado
          - [ ] Tests pasando
          - [ ] DocumentaciÃ³n actualizada
          - [ ] Sin errores de linting

          ---

          ðŸ¤– **PR creado automÃ¡ticamente por GitHub Actions**

          - Workflow: \`${{ github.workflow }}\`
          - Branch: \`$BRANCH\`
          - Triggered by: @${{ github.actor }}
          EOF

          # Crear PR
          gh pr create \
            --title "$TITLE" \
            --body-file /tmp/pr-body.md \
            --base main \
            --head "$BRANCH" \
            --label "$LABEL,auto-generated"

          echo "âœ… PR creado exitosamente"

      - name: ðŸ“¢ Resumen
        run: |
          if [[ "${{ steps.check_pr.outputs.pr_exists }}" == "true" ]]; then
            echo "âœ… PR #${{ steps.check_pr.outputs.pr_number }} ya existe"
          else
            echo "âœ… Nuevo PR creado para branch ${{ steps.check_pr.outputs.branch }}"
          fi
