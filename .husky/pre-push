#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸš€ Pre-push: Validaciones completas..."

# Contar archivos cambiados
CHANGED_FILES=$(git diff --name-only origin/main...HEAD 2>/dev/null | wc -l)

echo "ğŸ“Š Archivos cambiados: $CHANGED_FILES"

# Si hay mÃ¡s de 100 archivos, skip local validation (correrÃ¡ en CI)
if [ "$CHANGED_FILES" -gt 100 ]; then
  echo "âš ï¸  Demasiados archivos modificados ($CHANGED_FILES > 100)"
  echo "â­ï¸  Saltando validaciÃ³n local (correrÃ¡ en CI/CD)"
  exit 0
fi

# Aumentar memoria de Node para ESLint
export NODE_OPTIONS="--max-old-space-size=8192"

# 1. Validar convenciones
echo "ğŸ“‹ Validando convenciones..."
node scripts/validate-conventions.mjs || exit 1

# 2. Verificar Router
echo "ğŸ—‚ï¸  Verificando App Router..."
if ls -d apps/**/pages 2>/dev/null | grep -v node_modules | grep .; then
  echo "âŒ Se detectÃ³ directorio pages/ - usar App Router"
  exit 1
fi

# 3. Lint solo archivos TypeScript/JavaScript cambiados
LINT_FILES=$(git diff --name-only --diff-filter=ACM origin/main...HEAD | grep -E '\.(ts|tsx|js|jsx)$' | tr '\n' ' ')

if [ -n "$LINT_FILES" ]; then
  echo "ğŸ” Linting archivos modificados..."
  NODE_OPTIONS="--max-old-space-size=8192" npx eslint $LINT_FILES --cache --max-warnings 0 || {
    echo "âŒ ESLint fallÃ³ (0 warnings permitidos)"
    exit 1
  }
else
  echo "âœ… No hay archivos TS/JS para validar"
fi

# 4. TypeCheck rÃ¡pido
echo "ğŸ” TypeCheck..."
pnpm turbo run typecheck || {
  echo "âŒ TypeCheck fallÃ³"
  exit 1
}

# 5. Build packages
echo "ğŸ—ï¸  Building packages..."
pnpm build:packages || {
  echo "âŒ Build fallÃ³"
  exit 1
}

echo "âœ… Pre-push validation completa - ready to push!"
