#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Contar archivos cambiados
CHANGED_FILES=$(git diff --name-only origin/main...HEAD 2>/dev/null | wc -l)

echo "üß™ pre-push: lint/typecheck (archivos cambiados: $CHANGED_FILES)"

# Si hay m√°s de 100 archivos, skip local validation (correr√° en CI)
if [ "$CHANGED_FILES" -gt 100 ]; then
  echo "‚ö†Ô∏è  Demasiados archivos modificados ($CHANGED_FILES > 100)"
  echo "‚è≠Ô∏è  Saltando validaci√≥n local (correr√° en CI/CD)"
  exit 0
fi

# Aumentar memoria de Node para ESLint
export NODE_OPTIONS="--max-old-space-size=8192"

# Lint solo archivos TypeScript/JavaScript cambiados
LINT_FILES=$(git diff --name-only --diff-filter=ACM origin/main...HEAD | grep -E '\.(ts|tsx|js|jsx)$' | tr '\n' ' ')

if [ -n "$LINT_FILES" ]; then
  echo "üîç Linting archivos modificados..."
  # Usar --cache para mejor performance
  NODE_OPTIONS="--max-old-space-size=8192" npx eslint $LINT_FILES --cache --max-warnings 100 || {
    echo "‚ö†Ô∏è  ESLint warnings encontrados (permitidos hasta 100)"
    exit 0
  }
else
  echo "‚úÖ No hay archivos TS/JS para validar"
fi

# TypeCheck r√°pido (solo packages modificados)
echo "üîç TypeCheck..."
pnpm type-check || {
  echo "‚ùå TypeCheck fall√≥"
  exit 1
}

echo "‚úÖ Pre-push validation completa"
