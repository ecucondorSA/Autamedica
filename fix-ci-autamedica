#!/bin/bash

# fix-ci-autamedica: DiagnÃ³stico y correcciÃ³n automÃ¡tica de CI/CD
# Uso: ./fix-ci-autamedica

set -e

echo "ğŸ”§ Fix CI/CD - Autamedica"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“… $(date)"
echo "ğŸ“ Proyecto: $(pwd | grep -o '[^/]*$')"
echo ""

# Colores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Contadores de errores
LINT_ERRORS=0
TYPE_ERRORS=0
SECURITY_ISSUES=0
CI_FAILURES=0

echo "ğŸ“‹ FASE 1: AnÃ¡lisis de GitHub Actions"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Verificar si GitHub CLI estÃ¡ disponible
if command -v gh >/dev/null 2>&1; then
    echo "âœ… GitHub CLI disponible"

    # Obtener Ãºltimos runs
    echo "ğŸ” Analizando Ãºltimos 10 workflows..."
    if gh run list --limit 10 > /tmp/gh_runs.txt 2>/dev/null; then
        echo "ğŸ“Š Estado de workflows recientes:"
        cat /tmp/gh_runs.txt | head -5

        # Contar failures
        FAILED_RUNS=$(grep -c "failure\|cancelled" /tmp/gh_runs.txt || echo "0")
        if [ "$FAILED_RUNS" -gt 0 ]; then
            echo -e "âŒ ${RED}$FAILED_RUNS workflow(s) fallidos detectados${NC}"
            CI_FAILURES=$FAILED_RUNS

            # Obtener ID del Ãºltimo run fallido
            LATEST_FAILED=$(grep "failure\|cancelled" /tmp/gh_runs.txt | head -1 | awk '{print $1}' || echo "")
            if [ -n "$LATEST_FAILED" ]; then
                echo "ğŸ” Ãšltimo workflow fallido: $LATEST_FAILED"
                echo "ğŸ“ Para ver logs: gh run view $LATEST_FAILED --log"
            fi
        else
            echo -e "âœ… ${GREEN}Todos los workflows recientes estÃ¡n OK${NC}"
        fi
    else
        echo -e "âš ï¸  ${YELLOW}No se pudo acceder a GitHub Actions (puede requerir autenticaciÃ³n)${NC}"
    fi
else
    echo -e "âš ï¸  ${YELLOW}GitHub CLI no instalado. Instalar con: curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo gpg --dearmor -o /usr/share/keyrings/githubcli-archive-keyring.gpg${NC}"
fi

echo ""
echo "ğŸ“‹ FASE 2: Lint Check (ESLint)"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

if [ -f "package.json" ] && grep -q "lint" package.json; then
    echo "ğŸ” Ejecutando lint check..."

    # Capturar output de lint
    if pnpm lint > /tmp/lint_output.txt 2>&1; then
        echo -e "âœ… ${GREEN}Lint check pasÃ³ correctamente${NC}"
    else
        LINT_ERRORS=$(wc -l < /tmp/lint_output.txt)
        echo -e "âŒ ${RED}Lint check fallÃ³ con $LINT_ERRORS lÃ­neas de error${NC}"
        echo ""
        echo "ğŸ” Errores de lint mÃ¡s comunes:"
        head -20 /tmp/lint_output.txt | grep -E "error|warning" || echo "Ver /tmp/lint_output.txt para detalles"
        echo ""
        echo "ğŸ› ï¸  CorrecciÃ³n sugerida:"
        echo "   pnpm lint --fix    # Auto-fix de issues menores"
        echo "   pnpm lint          # Ver errores restantes"
    fi
else
    echo -e "âš ï¸  ${YELLOW}Script de lint no encontrado en package.json${NC}"
fi

echo ""
echo "ğŸ“‹ FASE 3: TypeScript Check"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

if [ -f "tsconfig.json" ]; then
    echo "ğŸ” Ejecutando TypeScript check..."

    # Verificar con tsc
    if pnpm tsc --noEmit > /tmp/tsc_output.txt 2>&1; then
        echo -e "âœ… ${GREEN}TypeScript check pasÃ³ correctamente${NC}"
    else
        TYPE_ERRORS=$(grep -c "error" /tmp/tsc_output.txt || echo "0")
        echo -e "âŒ ${RED}TypeScript check fallÃ³ con $TYPE_ERRORS errores${NC}"
        echo ""
        echo "ğŸ” Errores de TypeScript mÃ¡s frecuentes:"
        head -15 /tmp/tsc_output.txt | grep "error" || echo "Ver /tmp/tsc_output.txt para detalles"
        echo ""
        echo "ğŸ› ï¸  Correcciones sugeridas:"
        echo "   â€¢ Revisar imports rotos"
        echo "   â€¢ Verificar tipos faltantes"
        echo "   â€¢ Actualizar @types/* packages si es necesario"
    fi
else
    echo -e "âš ï¸  ${YELLOW}tsconfig.json no encontrado${NC}"
fi

echo ""
echo "ğŸ“‹ FASE 4: Security Audit"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

echo "ğŸ” Ejecutando audit de seguridad..."
if pnpm audit > /tmp/audit_output.txt 2>&1; then
    echo -e "âœ… ${GREEN}No se encontraron vulnerabilidades crÃ­ticas${NC}"
else
    # Contar vulnerabilidades
    HIGH_VULNS=$(grep -c "high" /tmp/audit_output.txt || echo "0")
    CRITICAL_VULNS=$(grep -c "critical" /tmp/audit_output.txt || echo "0")
    SECURITY_ISSUES=$((HIGH_VULNS + CRITICAL_VULNS))

    if [ "$SECURITY_ISSUES" -gt 0 ]; then
        echo -e "âŒ ${RED}$SECURITY_ISSUES vulnerabilidades crÃ­ticas/altas encontradas${NC}"
        echo ""
        echo "ğŸ” Resumen de vulnerabilidades:"
        grep -E "critical|high" /tmp/audit_output.txt | head -10 || echo "Ver /tmp/audit_output.txt para detalles"
        echo ""
        echo "ğŸ› ï¸  CorrecciÃ³n sugerida:"
        echo "   pnpm audit fix    # Auto-fix vulnerabilidades"
        echo "   pnpm update       # Actualizar dependencias"
    else
        echo -e "âš ï¸  ${YELLOW}Vulnerabilidades menores encontradas (no crÃ­ticas)${NC}"
    fi
fi

echo ""
echo "ğŸ“‹ FASE 5: Build Test"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

echo "ğŸ” Verificando que el proyecto compile..."
if pnpm build > /tmp/build_output.txt 2>&1; then
    echo -e "âœ… ${GREEN}Build completado exitosamente${NC}"
else
    echo -e "âŒ ${RED}Build fallÃ³${NC}"
    echo ""
    echo "ğŸ” Errores de build:"
    tail -20 /tmp/build_output.txt | grep -E "error|Error" || echo "Ver /tmp/build_output.txt para detalles"
fi

echo ""
echo "ğŸ“‹ FASE 6: ValidaciÃ³n de Glosario MÃ©dico"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

echo "ğŸ” Validando terminologÃ­a mÃ©dica y naming conventions..."
if [ -f "scripts/check-glossary.js" ]; then
    if node scripts/check-glossary.js > /tmp/glossary_output.txt 2>&1; then
        echo -e "âœ… ${GREEN}Glosario mÃ©dico: Sin issues crÃ­ticos${NC}"
    else
        GLOSSARY_ERRORS=$(grep -c "âŒ Errores:" /tmp/glossary_output.txt || echo "0")
        GLOSSARY_WARNINGS=$(grep -c "âš ï¸  Warnings:" /tmp/glossary_output.txt || echo "0")

        if [ "$GLOSSARY_ERRORS" -gt 0 ]; then
            echo -e "âŒ ${RED}Glosario mÃ©dico: $GLOSSARY_ERRORS errores de terminologÃ­a${NC}"
            echo ""
            echo "ğŸ” Errores mÃ¡s frecuentes:"
            head -10 /tmp/glossary_output.txt | grep "TÃ©rmino prohibido\|violaciÃ³n HIPAA" || echo "Ver /tmp/glossary_output.txt para detalles"
        fi

        if [ "$GLOSSARY_WARNINGS" -gt 5 ]; then
            echo -e "âš ï¸  ${YELLOW}Glosario mÃ©dico: Muchos warnings de terminologÃ­a${NC}"
        fi
    fi
else
    echo -e "âš ï¸  ${YELLOW}Script de glosario no encontrado (scripts/check-glossary.js)${NC}"
fi

echo ""
echo "ğŸ“‹ FASE 7: ConfiguraciÃ³n Cloudflare Pages"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Verificar workflows que aÃºn referencien Vercel
if [ -d ".github/workflows" ]; then
    echo "ğŸ” Verificando workflows de GitHub Actions..."

    VERCEL_REFS=$(grep -r "vercel" .github/workflows/ 2>/dev/null | wc -l || echo "0")
    if [ "$VERCEL_REFS" -gt 0 ]; then
        echo -e "âš ï¸  ${YELLOW}$VERCEL_REFS referencias a Vercel encontradas en workflows${NC}"
        echo "ğŸ“ Archivos con referencias a Vercel:"
        grep -r "vercel" .github/workflows/ 2>/dev/null || true
        echo ""
        echo "ğŸ› ï¸  AcciÃ³n requerida: Reemplazar/eliminar referencias a Vercel"
    else
        echo -e "âœ… ${GREEN}No se encontraron referencias obsoletas a Vercel${NC}"
    fi

    # Verificar si hay configuraciÃ³n para Cloudflare
    CLOUDFLARE_REFS=$(grep -r "wrangler\|cloudflare" .github/workflows/ 2>/dev/null | wc -l || echo "0")
    if [ "$CLOUDFLARE_REFS" -gt 0 ]; then
        echo -e "âœ… ${GREEN}ConfiguraciÃ³n de Cloudflare detectada en workflows${NC}"
    else
        echo -e "âš ï¸  ${YELLOW}No se detectÃ³ configuraciÃ³n de Cloudflare en workflows${NC}"
    fi
fi

echo ""
echo "ğŸ“Š RESUMEN DE PROBLEMAS DETECTADOS"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

GLOSSARY_ISSUES=${GLOSSARY_ERRORS:-0}
TOTAL_ISSUES=$((LINT_ERRORS + TYPE_ERRORS + SECURITY_ISSUES + CI_FAILURES + GLOSSARY_ISSUES))

echo "ğŸ“ˆ Total de issues: $TOTAL_ISSUES"
echo -e "ğŸ”§ Lint errors: ${RED}$LINT_ERRORS${NC}"
echo -e "ğŸ“ TypeScript errors: ${RED}$TYPE_ERRORS${NC}"
echo -e "ğŸ”’ Security issues: ${RED}$SECURITY_ISSUES${NC}"
echo -e "âš™ï¸ CI failures: ${RED}$CI_FAILURES${NC}"
echo -e "ğŸ“š Glossary issues: ${RED}$GLOSSARY_ISSUES${NC}"

echo ""
if [ "$TOTAL_ISSUES" -eq 0 ]; then
    echo -e "ğŸ‰ ${GREEN}Â¡NO SE ENCONTRARON PROBLEMAS CRÃTICOS!${NC}"
    echo "âœ… El proyecto estÃ¡ listo para CI/CD"
else
    echo -e "âš ï¸  ${YELLOW}PLAN DE CORRECCIÃ“N SUGERIDO:${NC}"
    echo ""

    if [ "$LINT_ERRORS" -gt 0 ]; then
        echo "1ï¸âƒ£ Corregir errores de lint:"
        echo "   pnpm lint --fix"
        echo "   # Revisar errores restantes manualmente"
        echo ""
    fi

    if [ "$TYPE_ERRORS" -gt 0 ]; then
        echo "2ï¸âƒ£ Corregir errores de TypeScript:"
        echo "   # Revisar /tmp/tsc_output.txt"
        echo "   # Corregir imports y tipos uno por uno"
        echo ""
    fi

    if [ "$SECURITY_ISSUES" -gt 0 ]; then
        echo "3ï¸âƒ£ Corregir vulnerabilidades:"
        echo "   pnpm audit fix"
        echo "   pnpm update"
        echo ""
    fi

    if [ "$GLOSSARY_ISSUES" -gt 0 ]; then
        echo "4ï¸âƒ£ Corregir terminologÃ­a mÃ©dica:"
        echo "   # Revisar /tmp/glossary_output.txt"
        echo "   # Reemplazar tÃ©rminos segÃºn glossary.json"
        echo "   node scripts/check-glossary.js  # Re-validar"
        echo ""
    fi

    if [ "$CI_FAILURES" -gt 0 ]; then
        echo "5ï¸âƒ£ Re-ejecutar CI despuÃ©s de correcciones:"
        echo "   git add ."
        echo "   ./git-claude  # Commit con formato estÃ¡ndar"
        echo "   git push      # Disparar GitHub Actions"
        echo ""
    fi
fi

echo "ğŸ”§ COMANDOS ÃšTILES PARA DEBUG:"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "gh run list --limit 5           # Ver Ãºltimos workflows"
echo "gh run view <ID> --log          # Ver logs de workflow especÃ­fico"
echo "pnpm lint                       # Check lint local"
echo "pnpm tsc --noEmit               # Check TypeScript local"
echo "pnpm audit                      # Check vulnerabilidades"
echo "pnpm build                      # Test build local"
echo "node scripts/check-glossary.js # Validar terminologÃ­a mÃ©dica"
echo "./git-claude                    # Commit con formato estÃ¡ndar"

echo ""
echo "ğŸ“ ARCHIVOS DE DEBUG GENERADOS:"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "/tmp/lint_output.txt           # Output completo de lint"
echo "/tmp/tsc_output.txt            # Output completo de TypeScript"
echo "/tmp/audit_output.txt          # Output completo de audit"
echo "/tmp/build_output.txt          # Output completo de build"
echo "/tmp/glossary_output.txt       # Output completo de glosario mÃ©dico"
echo "/tmp/gh_runs.txt               # Lista de workflows GitHub"