<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Edge Functions</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ccc; border-radius: 5px; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .result { margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 3px; font-family: monospace; white-space: pre-wrap; }
        .error { background: #f8d7da; color: #721c24; }
        .success { background: #d4edda; color: #155724; }
        input { padding: 8px; margin: 5px; border: 1px solid #ccc; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>AutaMedica Edge Functions Test</h1>

    <div class="test-section">
        <h2>üîë Authentication Setup</h2>
        <p>First, get your auth token from the browser console:</p>
        <code>localStorage.getItem('supabase.auth.token')</code>
        <br><br>
        <input type="text" id="authToken" placeholder="Paste your auth token here" style="width: 500px;">
        <button onclick="setAuthToken()">Set Token</button>
        <div id="authResult" class="result"></div>
    </div>

    <div class="test-section">
        <h2>üìû Test Create Call</h2>
        <input type="text" id="doctorId" placeholder="Doctor ID" value="test-doctor-123">
        <input type="text" id="patientId" placeholder="Patient ID" value="test-patient-456">
        <button onclick="testCreateCall()">Create Call</button>
        <div id="createCallResult" class="result"></div>
    </div>

    <div class="test-section">
        <h2>üîÑ Test Update Call Status</h2>
        <input type="text" id="callId" placeholder="Call ID (from create call response)">
        <select id="callStatus">
            <option value="ringing">Ringing</option>
            <option value="accepted">Accepted</option>
            <option value="ended">Ended</option>
            <option value="declined">Declined</option>
            <option value="cancelled">Cancelled</option>
        </select>
        <input type="text" id="reason" placeholder="Reason (optional)">
        <button onclick="testUpdateCall()">Update Status</button>
        <div id="updateCallResult" class="result"></div>
    </div>

    <div class="test-section">
        <h2>üìä Test Results Summary</h2>
        <div id="summary" class="result">
            No tests run yet...
        </div>
    </div>

    <script>
        let authToken = '';
        const results = {
            createCall: null,
            updateCall: null
        };

        function setAuthToken() {
            authToken = document.getElementById('authToken').value;
            if (authToken) {
                document.getElementById('authResult').innerHTML = '‚úÖ Auth token set!';
                document.getElementById('authResult').className = 'result success';
            } else {
                document.getElementById('authResult').innerHTML = '‚ùå Please enter an auth token';
                document.getElementById('authResult').className = 'result error';
            }
        }

        async function testCreateCall() {
            const doctorId = document.getElementById('doctorId').value;
            const patientId = document.getElementById('patientId').value;
            const resultDiv = document.getElementById('createCallResult');

            if (!authToken) {
                resultDiv.innerHTML = '‚ùå Please set auth token first';
                resultDiv.className = 'result error';
                return;
            }

            try {
                resultDiv.innerHTML = '‚è≥ Creating call...';
                resultDiv.className = 'result';

                const response = await fetch('https://gtyvdircfhmdjiaelqkg.supabase.co/functions/v1/create-call', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json',
                        'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd0eXZkaXJjZmhtZGppYWVscWtnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2Njc4NTUsImV4cCI6MjA3MjI0Mzg1NX0.DeEm08k7QOrKObWaz8AUaOB5N6Z2QZhZHFaUf2siALA'
                    },
                    body: JSON.stringify({
                        doctorId: doctorId,
                        patientId: patientId
                    })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    resultDiv.innerHTML = `‚úÖ Call created successfully!\n\nCall ID: ${result.call.id}\nRoom ID: ${result.call.room_id}\nStatus: ${result.call.status}`;
                    resultDiv.className = 'result success';

                    // Auto-fill call ID for update test
                    document.getElementById('callId').value = result.call.id;

                    results.createCall = result;
                } else {
                    resultDiv.innerHTML = `‚ùå Error: ${result.error || 'Unknown error'}\n\nDetails: ${result.details || 'No details'}`;
                    resultDiv.className = 'result error';
                    results.createCall = { error: result.error };
                }
            } catch (error) {
                resultDiv.innerHTML = `‚ùå Network error: ${error.message}`;
                resultDiv.className = 'result error';
                results.createCall = { error: error.message };
            }

            updateSummary();
        }

        async function testUpdateCall() {
            const callId = document.getElementById('callId').value;
            const status = document.getElementById('callStatus').value;
            const reason = document.getElementById('reason').value;
            const resultDiv = document.getElementById('updateCallResult');

            if (!authToken) {
                resultDiv.innerHTML = '‚ùå Please set auth token first';
                resultDiv.className = 'result error';
                return;
            }

            if (!callId) {
                resultDiv.innerHTML = '‚ùå Please enter a call ID';
                resultDiv.className = 'result error';
                return;
            }

            try {
                resultDiv.innerHTML = '‚è≥ Updating call status...';
                resultDiv.className = 'result';

                const response = await fetch('https://gtyvdircfhmdjiaelqkg.supabase.co/functions/v1/update-call-status', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json',
                        'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd0eXZkaXJjZmhtZGppYWVscWtnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2Njc4NTUsImV4cCI6MjA3MjI0Mzg1NX0.DeEm08k7QOrKObWaz8AUaOB5N6Z2QZhZHFaUf2siALA'
                    },
                    body: JSON.stringify({
                        callId: callId,
                        status: status,
                        reason: reason || null
                    })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    resultDiv.innerHTML = `‚úÖ Call status updated successfully!\n\nUpdated: ${result.updated}`;
                    resultDiv.className = 'result success';
                    results.updateCall = result;
                } else {
                    resultDiv.innerHTML = `‚ùå Error: ${result.error || 'Unknown error'}\n\nDetails: ${result.details || 'No details'}`;
                    resultDiv.className = 'result error';
                    results.updateCall = { error: result.error };
                }
            } catch (error) {
                resultDiv.innerHTML = `‚ùå Network error: ${error.message}`;
                resultDiv.className = 'result error';
                results.updateCall = { error: error.message };
            }

            updateSummary();
        }

        function updateSummary() {
            const summaryDiv = document.getElementById('summary');
            let summary = 'Test Results:\n\n';

            if (results.createCall) {
                summary += `Create Call: ${results.createCall.error ? '‚ùå Failed' : '‚úÖ Success'}\n`;
            }

            if (results.updateCall) {
                summary += `Update Call: ${results.updateCall.error ? '‚ùå Failed' : '‚úÖ Success'}\n`;
            }

            if (results.createCall && results.updateCall && !results.createCall.error && !results.updateCall.error) {
                summary += '\nüéâ All tests passed! Edge Functions are working correctly.';
                summaryDiv.className = 'result success';
            } else if (results.createCall || results.updateCall) {
                summary += '\n‚ö†Ô∏è Some tests failed. Check individual results above.';
                summaryDiv.className = 'result error';
            }

            summaryDiv.innerHTML = summary;
        }

        // Instructions on page load
        window.onload = function() {
            console.log('AutaMedica Edge Functions Test Page Loaded');
            console.log('1. Open browser devtools and get your auth token');
            console.log('2. If you have Supabase auth setup: localStorage.getItem("supabase.auth.token")');
            console.log('3. Or use a test token if the Edge Functions are deployed');
        };
    </script>
</body>
</html>