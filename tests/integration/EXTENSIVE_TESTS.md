# üî¨ Tests Extensos - Long-Running Integration Tests

Tests automatizados extensivos con interacciones largas, timeouts extendidos y validaci√≥n detallada de cada paso.

## üéØ Diferencias con Tests Est√°ndar

| Aspecto | Tests Est√°ndar | Tests Extensos |
|---------|---------------|----------------|
| **Duraci√≥n** | 30-60 segundos | 2-5 minutos |
| **Timeout** | 30 segundos | 120-300 segundos |
| **Logging** | B√°sico | Detallado en cada paso |
| **Screenshots** | Solo en fallos | En cada fase |
| **Validaciones** | Esenciales | Exhaustivas |
| **Interacciones** | R√°pidas | Con delays realistas |
| **Fases** | 3-5 | 10-15 |

---

## üöÄ Ejecutar Tests Extensos

### Comando Principal

```bash
# Ejecutar tests extensivos con navegador visible
pnpm test:auth:extensive
```

### Comando Watch (Desarrollo)

```bash
# Re-ejecutar en cada cambio
pnpm test:auth:extensive:watch
```

---

## üìã Tests Implementados

### Test 1: Complete Patient Journey (11 Fases)

**Duraci√≥n estimada:** 2-3 minutos
**Timeout:** 3 minutos (180 segundos)

**Fases:**

| Fase | Acci√≥n | Duraci√≥n |
|------|--------|----------|
| 1 | Verificar estado inicial limpio | 5s |
| 2 | Navegar a login y verificar elementos | 10s |
| 3 | Realizar login con validaci√≥n | 15s |
| 4 | Esperar procesamiento de autenticaci√≥n | 10s |
| 5 | Manejar selecci√≥n de rol (si aplica) | 5s |
| 6 | Esperar redirect a patients app | 15s |
| 7 | Verificar estado de autenticaci√≥n | 5s |
| 8 | Esperar carga completa del dashboard | 10s |
| 9 | Verificar contenido del dashboard | 10s |
| 10 | Probar navegaci√≥n interna (profile) | 10s |
| 11 | Verificar persistencia en reload | 15s |

**Total:** ~110 segundos + buffers = 2-3 minutos

**Lo que verifica:**
- ‚úÖ Cleanup inicial de auth state
- ‚úÖ Presencia de todos los elementos de login
- ‚úÖ Login exitoso con credenciales correctas
- ‚úÖ Procesamiento de token y sesi√≥n
- ‚úÖ Selecci√≥n de rol para nuevos usuarios
- ‚úÖ Redirect correcto a patients app
- ‚úÖ Sesi√≥n creada en localStorage/cookies
- ‚úÖ Dashboard carga completamente
- ‚úÖ Contenido correcto del dashboard
- ‚úÖ Navegaci√≥n interna funciona
- ‚úÖ Sesi√≥n persiste en page reload

---

### Test 2: Cross-App Protection Journey (7 Fases)

**Duraci√≥n estimada:** 3-4 minutos
**Timeout:** 3 minutos (180 segundos)

**Fases:**

| Fase | Acci√≥n | Duraci√≥n |
|------|--------|----------|
| 1 | Login como paciente | 20s |
| 2 | Verificar ubicaci√≥n en patients app | 5s |
| 3 | Intentar acceder a doctors app (bloqueado) | 15s |
| 4 | Intentar acceder a companies app (bloqueado) | 15s |
| 5 | Intentar acceder a admin app (bloqueado) | 15s |
| 6 | Verificar autenticaci√≥n persiste | 5s |
| 7 | Verificar acceso leg√≠timo funciona | 10s |

**Total:** ~85 segundos + buffers + 3 intentos de acceso = 3-4 minutos

**Lo que verifica:**
- ‚úÖ Login exitoso como paciente
- ‚úÖ Redirect correcto a patients app
- ‚úÖ Middleware bloquea acceso a doctors app
- ‚úÖ Middleware bloquea acceso a companies app
- ‚úÖ Middleware bloquea acceso a admin app
- ‚úÖ Sesi√≥n NO se pierde durante redirects
- ‚úÖ Acceso leg√≠timo sigue funcionando

---

### Test 3: ReturnUrl Journey (4 Fases)

**Duraci√≥n estimada:** 1-2 minutos
**Timeout:** 2 minutos (120 segundos)

**Fases:**

| Fase | Acci√≥n | Duraci√≥n |
|------|--------|----------|
| 1 | Navegar a login con returnUrl | 8s |
| 2 | Realizar login | 15s |
| 3 | Esperar redirect | 15s |
| 4 | Verificar URL final contiene path correcto | 5s |

**Total:** ~43 segundos + buffers = 1-2 minutos

**Lo que verifica:**
- ‚úÖ returnUrl se preserva en login URL
- ‚úÖ Login procesa correctamente
- ‚úÖ Redirect va a la URL espec√≠fica (no solo app)
- ‚úÖ Path final es exactamente el solicitado

---

## üîç Logging Detallado

Los tests extensos generan logs detallados en cada paso:

```bash
[2025-10-04T16:45:23.123Z] üöÄ Starting new test
[2025-10-04T16:45:23.456Z] üßπ Starting extensive auth state cleanup...
[2025-10-04T16:45:23.789Z] Found 3 localStorage keys
[2025-10-04T16:45:24.012Z] Found 5 cookies to clear
[2025-10-04T16:45:24.345Z] ‚úÖ Cleanup complete. Remaining localStorage keys: 0
[2025-10-04T16:45:24.678Z] ‚è≥ Waiting 2000ms - Allow cleanup to propagate
[2025-10-04T16:45:26.901Z] ‚úÖ Wait completed - Allow cleanup to propagate

[2025-10-04T16:45:27.234Z] üéØ TEST: Complete patient journey with extensive validation
[2025-10-04T16:45:27.567Z] Expected duration: 2-3 minutes

[2025-10-04T16:45:28.890Z] üìã PHASE 1: Verify initial state
[2025-10-04T16:45:29.123Z] üìç Navigating to: http://localhost:3000
...
```

**Tipos de logs:**
- üöÄ Inicio de test
- üßπ Limpieza de estado
- üéØ Descripci√≥n del test
- üìã Inicio de fase
- üîç B√∫squeda de elementos
- ‚úçÔ∏è Interacci√≥n con formularios
- üñ±Ô∏è Clicks
- üîÑ Navegaci√≥n/Redirects
- ‚è≥ Esperas
- ‚úÖ Verificaciones exitosas
- ‚ùå Errores
- üì∏ Screenshots
- üìç Cambios de URL

---

## üì∏ Screenshots Autom√°ticos

Los tests extensos capturan screenshots en momentos clave:

```
test-results/screenshots/
‚îú‚îÄ‚îÄ before-login.png           # Antes de llenar formulario
‚îú‚îÄ‚îÄ before-submit.png          # Despu√©s de llenar, antes de submit
‚îú‚îÄ‚îÄ content-verification-failed.png  # Si falla verificaci√≥n de contenido
‚îú‚îÄ‚îÄ final-page-state.png       # Estado final de cada test
‚îú‚îÄ‚îÄ test-complete.png          # Al completar test exitosamente
‚îú‚îÄ‚îÄ on-patients-app.png        # Confirmaci√≥n en patients app
‚îú‚îÄ‚îÄ blocked-doctors.png        # Despu√©s de bloquear doctors
‚îú‚îÄ‚îÄ blocked-companies.png      # Despu√©s de bloquear companies
‚îî‚îÄ‚îÄ blocked-admin.png          # Despu√©s de bloquear admin
```

**Ubicaci√≥n:** `test-results/screenshots/`

**Uso:**
- Debugging: Ver exactamente qu√© pas√≥ en cada paso
- Evidencia: Screenshots sirven como evidencia de que los tests pasaron
- Troubleshooting: Comparar screenshots entre ejecuciones

---

## üé¨ Ejemplo de Ejecuci√≥n Completa

```bash
$ pnpm test:auth:extensive

 RUN  v3.2.4 /root/altamedica-reboot-fresh

 ‚úì tests/integration/auth-extensive.browser.test.ts (3) 287.45s
   ‚úì EXTENSIVE Auth Flow - Complete Patient Journey (1) 162.34s
     ‚úì Complete patient authentication and app exploration journey 162.34s
       [16:45:23] üöÄ Starting new test
       [16:45:23] üßπ Starting extensive auth state cleanup...
       [16:45:26] üéØ TEST: Complete patient journey with extensive validation
       [16:45:27] üìã PHASE 1: Verify initial state
       [16:45:32] üìã PHASE 2: Navigate to login page
       [16:45:40] üìã PHASE 3: Perform login
       [16:45:55] üìã PHASE 4: Wait for authentication processing
       [16:46:03] üìã PHASE 5: Wait for redirect to patients app
       [16:46:18] üìã PHASE 6: Verify authentication state
       [16:46:23] üìã PHASE 7: Wait for dashboard to fully load
       [16:46:33] üìã PHASE 8: Verify dashboard content
       [16:46:43] üìã PHASE 9: Test in-app navigation
       [16:46:56] üìã PHASE 10: Test session persistence on reload
       [16:47:11] üìã PHASE 11: Final comprehensive check
       [16:47:25] ‚úÖ TEST COMPLETED SUCCESSFULLY

   ‚úì EXTENSIVE Auth Flow - Cross-App Protection Journey (1) 89.23s
     ‚úì Patient login and attempt to access all other apps 89.23s
       [16:47:26] üéØ TEST: Cross-app protection with extensive validation
       [16:47:30] üìã PHASE 1: Login as patient
       [16:47:50] üìã PHASE 2: Verify current location
       [16:47:55] üìã PHASE 3: Attempt unauthorized access to doctors app
       [16:48:10] üìã PHASE 4: Attempt unauthorized access to companies app
       [16:48:25] üìã PHASE 5: Attempt unauthorized access to admin app
       [16:48:40] üìã PHASE 6: Verify authentication persisted
       [16:48:45] üìã PHASE 7: Verify legitimate access still works
       [16:48:55] ‚úÖ TEST COMPLETED SUCCESSFULLY

   ‚úì EXTENSIVE Auth Flow - ReturnUrl Journey (1) 35.88s
     ‚úì Login with returnUrl and verify complete redirect flow 35.88s
       [16:48:56] üéØ TEST: ReturnUrl preservation with extensive validation
       [16:49:00] üìã PHASE 1: Navigate to login with returnUrl parameter
       [16:49:08] üìã PHASE 2: Perform login
       [16:49:23] üìã PHASE 3: Wait for redirect to returnUrl
       [16:49:33] üìã PHASE 4: Verify final URL matches returnUrl
       [16:49:32] ‚úÖ TEST COMPLETED SUCCESSFULLY

 Test Files  1 passed (1)
      Tests  3 passed (3)
   Start at  16:45:22
   Duration  4m 47s (transform 12ms, setup 45ms, collect 3.2s, tests 287.45s)

  PASS  All tests passed!
```

---

## ‚öôÔ∏è Configuraci√≥n

### Timeouts Configurados

En `vitest.browser.config.ts`:

```typescript
testTimeout: 300000,   // 5 minutos por test
hookTimeout: 120000,   // 2 minutos para hooks
slowMo: 500,           // 500ms delay entre interacciones (visibilidad)
```

### Modificar Timeouts

Para hacer los tests a√∫n M√ÅS largos:

```typescript
// tests/integration/auth-extensive.browser.test.ts
const TIMEOUTS = {
  LONG_NAVIGATION: 120000,   // 2 minutos
  VERY_LONG: 240000,         // 4 minutos
  ULTRA_LONG: 360000,        // 6 minutos
  PAGE_LOAD: 60000,          // 1 minuto
  INTERACTION: 20000,        // 20 segundos
  ANIMATION: 5000            // 5 segundos
}
```

### Agregar M√°s Delays

```typescript
// Ejemplo: Esperar m√°s tiempo en cada fase
await waitWithLog(10000, 'Extra stabilization time')  // 10 segundos
```

---

## üêõ Troubleshooting

### Test falla con "timeout exceeded"

**Causa:** El test realmente necesita m√°s tiempo.

**Soluci√≥n 1:** Aumentar timeout espec√≠fico
```typescript
test('mi test', async () => {
  // ...
}, 600000) // 10 minutos
```

**Soluci√≥n 2:** Aumentar timeout global
```typescript
// vitest.browser.config.ts
testTimeout: 600000  // 10 minutos
```

---

### Screenshots no se generan

**Causa:** Directorio `test-results/screenshots/` no existe.

**Soluci√≥n:**
```bash
mkdir -p test-results/screenshots
```

---

### Navegador se cierra demasiado r√°pido

**Causa:** Test complet√≥ y cerr√≥ navegador autom√°ticamente.

**Soluci√≥n:** Agregar delay antes del final
```typescript
await waitWithLog(30000, 'Keep browser open for inspection')
```

---

### Logs no aparecen en terminal

**Causa:** Reporter de Vitest puede estar ocult√°ndolos.

**Soluci√≥n:** Usar reporter verbose
```bash
pnpm test:auth:extensive --reporter=verbose
```

---

## üéØ Cu√°ndo Usar Tests Extensos

### ‚úÖ Usar cuando:

- Debugging de flujos completos
- Validaci√≥n manual visual necesaria
- Problemas intermitentes que requieren observaci√≥n
- Documentaci√≥n con screenshots paso a paso
- Demostraci√≥n a stakeholders
- Verificaci√≥n de timing y performance
- Testing de escenarios edge case complejos

### ‚ùå NO usar cuando:

- CI/CD (demasiado lentos)
- Tests r√°pidos de regresi√≥n
- Pre-commit hooks
- Desarrollo iterativo r√°pido

---

## üìä Comparativa

| Caracter√≠stica | Tests Est√°ndar | Tests Extensos |
|---------------|----------------|----------------|
| **Ejecuci√≥n completa** | ~1 minuto | ~5 minutos |
| **Logs por test** | ~20 l√≠neas | ~200 l√≠neas |
| **Screenshots** | 1-2 | 10-15 |
| **Validaciones** | Esenciales | Exhaustivas |
| **Uso en CI** | ‚úÖ S√≠ | ‚ùå No |
| **Debugging** | B√°sico | ‚úÖ Excelente |
| **Visibilidad** | Media | ‚úÖ Total |

---

## üöÄ Pr√≥ximos Tests Extensos a Agregar

- [ ] Doctor complete journey (similar a patient)
- [ ] Company admin complete journey
- [ ] Admin platform journey
- [ ] OAuth login flow (Google/GitHub)
- [ ] Password reset complete flow
- [ ] Email verification flow
- [ ] Multi-device session testing
- [ ] Session expiration handling
- [ ] Network failure recovery
- [ ] Offline mode testing

---

## üìö Referencias

- Tests est√°ndar: `auth-redirects.browser.test.ts`
- Configuraci√≥n: `vitest.browser.config.ts`
- Helper functions: `setup.ts`
- Estrategia: `/tmp/auth-redirect-testing-strategy-2025.md`

---

**Creado:** 2025-10-04
**Duraci√≥n t√≠pica:** 5-10 minutos para suite completa
**Recomendado para:** Debugging profundo y validaci√≥n exhaustiva
