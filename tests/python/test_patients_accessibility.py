# tests/python/test_patients_accessibility.py
import pytest
from playwright.sync_api import sync_playwright
from pathlib import Path

def test_patients_app_accessibility():
    """Test de accesibilidad para la app de pacientes"""
    
    with sync_playwright() as p:
        browser = p.chromium.launch(headless=True)
        page = browser.new_context().new_page()
        
        try:
            # 1. Navegar a la app de pacientes
            print("üåê Navegando a la app de pacientes...")
            page.goto("http://localhost:3003")
            page.wait_for_load_state("networkidle")
            page.wait_for_timeout(2000)
            
            # 2. Verificar que la p√°gina carga
            current_url = page.url
            title = page.title()
            
            print(f"üìç URL actual: {current_url}")
            print(f"üìÑ T√≠tulo: {title}")
            
            # 3. Verificar accesibilidad b√°sica
            print("‚ôø Verificando accesibilidad b√°sica...")
            
            # Verificar que hay texto visible
            body_text = page.locator("body").text_content()
            assert body_text is not None, "No hay texto visible en la p√°gina"
            assert len(body_text.strip()) > 0, "El texto visible est√° vac√≠o"
            
            print(f"üìù Texto visible encontrado: {len(body_text)} caracteres")
            
            # 4. Verificar elementos sem√°nticos
            print("üèóÔ∏è Verificando elementos sem√°nticos...")
            
            # Verificar que hay headings
            headings = page.locator("h1, h2, h3, h4, h5, h6")
            heading_count = headings.count()
            print(f"üìã Headings encontrados: {heading_count}")
            
            # Verificar que hay elementos interactivos
            interactive_elements = page.locator("button, a, input, select, textarea")
            interactive_count = interactive_elements.count()
            print(f"üéØ Elementos interactivos: {interactive_count}")
            
            # Verificar que hay elementos con roles ARIA
            aria_elements = page.locator("[role]")
            aria_count = aria_elements.count()
            print(f"üé≠ Elementos con roles ARIA: {aria_count}")
            
            # 5. Verificar que hay estructura de navegaci√≥n
            print("üß≠ Verificando estructura de navegaci√≥n...")
            
            # Verificar que hay elementos de navegaci√≥n
            nav_elements = page.locator("nav, [role='navigation']")
            nav_count = nav_elements.count()
            print(f"üß≠ Elementos de navegaci√≥n: {nav_count}")
            
            # Verificar que hay enlaces
            links = page.locator("a")
            link_count = links.count()
            print(f"üîó Enlaces: {link_count}")
            
            # 6. Verificar que hay contenido principal
            print("üìÑ Verificando contenido principal...")
            
            # Verificar que hay elementos de contenido principal
            main_elements = page.locator("main, [role='main']")
            main_count = main_elements.count()
            print(f"üìÑ Elementos main: {main_count}")
            
            # Verificar que hay contenido de la p√°gina
            content_elements = page.locator("div, section, article")
            content_count = content_elements.count()
            print(f"üì¶ Elementos de contenido: {content_count}")
            
            # 7. Verificar que no hay errores JavaScript cr√≠ticos
            print("üîß Verificando errores JavaScript...")
            
            js_errors = []
            page.on("pageerror", lambda error: js_errors.append(error.message))
            page.wait_for_timeout(2000)
            
            # Filtrar errores no cr√≠ticos
            critical_errors = [error for error in js_errors 
                              if not any(term in error.lower() for term in 
                                       ['notallowederror', 'notfounderror', 'media', 'webrtc', 'network'])]
            
            print(f"üîß Errores JavaScript cr√≠ticos: {len(critical_errors)}")
            if critical_errors:
                print(f"‚ö†Ô∏è Errores encontrados: {critical_errors}")
            
            # 8. Verificar que la p√°gina es responsive
            print("üì± Verificando responsividad...")
            
            # Verificar que hay elementos que sugieren una interfaz responsive
            responsive_elements = page.locator("[class*='flex'], [class*='grid'], [class*='responsive']")
            responsive_count = responsive_elements.count()
            print(f"üì± Elementos responsive: {responsive_count}")
            
            # 9. Verificar que hay elementos de formulario accesibles
            print("üìù Verificando elementos de formulario...")
            
            # Verificar que hay inputs con labels
            inputs = page.locator("input")
            input_count = inputs.count()
            print(f"üìù Inputs encontrados: {input_count}")
            
            # Verificar que hay botones accesibles
            buttons = page.locator("button")
            button_count = buttons.count()
            print(f"üîò Botones encontrados: {button_count}")
            
            # 10. Verificar que hay elementos de ayuda
            print("‚ùì Verificando elementos de ayuda...")
            
            # Verificar que hay elementos de ayuda
            help_elements = page.locator("[title], [aria-label], [aria-describedby]")
            help_count = help_elements.count()
            print(f"‚ùì Elementos de ayuda: {help_count}")
            
            # 11. Generar reporte de accesibilidad
            print("\nüéâ ¬°Test de accesibilidad completado exitosamente!")
            print(f"‚úÖ URL: {current_url}")
            print(f"‚úÖ T√≠tulo: {title}")
            print(f"‚úÖ Texto visible: {len(body_text)} caracteres")
            print(f"‚úÖ Headings: {heading_count}")
            print(f"‚úÖ Elementos interactivos: {interactive_count}")
            print(f"‚úÖ Elementos ARIA: {aria_count}")
            print(f"‚úÖ Navegaci√≥n: {nav_count}")
            print(f"‚úÖ Enlaces: {link_count}")
            print(f"‚úÖ Contenido principal: {main_count}")
            print(f"‚úÖ Elementos de contenido: {content_count}")
            print(f"‚úÖ Inputs: {input_count}")
            print(f"‚úÖ Botones: {button_count}")
            print(f"‚úÖ Elementos de ayuda: {help_count}")
            print(f"‚úÖ Elementos responsive: {responsive_count}")
            print(f"‚úÖ Errores JavaScript cr√≠ticos: {len(critical_errors)}")
            
            # Verificar que la p√°gina cumple con est√°ndares b√°sicos de accesibilidad
            assert heading_count > 0 or interactive_count > 0, "La p√°gina debe tener headings o elementos interactivos"
            assert interactive_count > 0, "La p√°gina debe tener elementos interactivos"
            assert len(critical_errors) == 0, f"Errores JavaScript cr√≠ticos encontrados: {critical_errors}"
            
            # El test pasa si llegamos hasta aqu√≠
            assert True, "Test de accesibilidad completado exitosamente"
            
        except Exception as e:
            print(f"‚ùå Error durante el test de accesibilidad: {e}")
            raise
        finally:
            browser.close()

def test_patients_app_keyboard_navigation():
    """Test de navegaci√≥n por teclado en la app de pacientes"""
    
    with sync_playwright() as p:
        browser = p.chromium.launch(headless=True)
        page = browser.new_context().new_page()
        
        try:
            # 1. Navegar a la app de pacientes
            print("üåê Navegando a la app de pacientes...")
            page.goto("http://localhost:3003")
            page.wait_for_load_state("networkidle")
            page.wait_for_timeout(2000)
            
            # 2. Verificar que la p√°gina carga
            current_url = page.url
            print(f"üìç URL actual: {current_url}")
            
            # 3. Verificar navegaci√≥n por teclado
            print("‚å®Ô∏è Verificando navegaci√≥n por teclado...")
            
            # Verificar que hay elementos enfocables
            focusable_elements = page.locator("button, a, input, select, textarea, [tabindex]")
            focusable_count = focusable_elements.count()
            print(f"üéØ Elementos enfocables: {focusable_count}")
            
            # Verificar que hay botones
            buttons = page.locator("button")
            button_count = buttons.count()
            print(f"üîò Botones: {button_count}")
            
            # Verificar que hay enlaces
            links = page.locator("a")
            link_count = links.count()
            print(f"üîó Enlaces: {link_count}")
            
            # 4. Verificar que la p√°gina es navegable
            print("üß≠ Verificando navegabilidad...")
            
            # Verificar que hay elementos de navegaci√≥n
            nav_elements = page.locator("nav, [role='navigation']")
            nav_count = nav_elements.count()
            print(f"üß≠ Elementos de navegaci√≥n: {nav_count}")
            
            # Verificar que hay contenido principal
            main_elements = page.locator("main, [role='main']")
            main_count = main_elements.count()
            print(f"üìÑ Contenido principal: {main_count}")
            
            # 5. Verificar que la p√°gina es accesible
            print("‚ôø Verificando accesibilidad...")
            
            # Verificar que hay texto visible
            body_text = page.locator("body").text_content()
            assert body_text is not None, "No hay texto visible en la p√°gina"
            assert len(body_text.strip()) > 0, "El texto visible est√° vac√≠o"
            
            # Verificar que hay elementos sem√°nticos
            semantic_elements = page.locator("h1, h2, h3, h4, h5, h6, button, a, input, select, textarea")
            semantic_count = semantic_elements.count()
            print(f"üé≠ Elementos sem√°nticos: {semantic_count}")
            
            # 6. Generar reporte de navegaci√≥n por teclado
            print("\nüéâ ¬°Test de navegaci√≥n por teclado completado exitosamente!")
            print(f"‚úÖ URL: {current_url}")
            print(f"‚úÖ Elementos enfocables: {focusable_count}")
            print(f"‚úÖ Botones: {button_count}")
            print(f"‚úÖ Enlaces: {link_count}")
            print(f"‚úÖ Navegaci√≥n: {nav_count}")
            print(f"‚úÖ Contenido principal: {main_count}")
            print(f"‚úÖ Elementos sem√°nticos: {semantic_count}")
            
            # Verificar que la p√°gina cumple con est√°ndares b√°sicos
            assert focusable_count > 0, "La p√°gina debe tener elementos enfocables"
            assert semantic_count > 0, "La p√°gina debe tener elementos sem√°nticos"
            
            # El test pasa si llegamos hasta aqu√≠
            assert True, "Test de navegaci√≥n por teclado completado exitosamente"
            
        except Exception as e:
            print(f"‚ùå Error durante el test de navegaci√≥n por teclado: {e}")
            raise
        finally:
            browser.close()

if __name__ == "__main__":
    # Ejecutar tests individuales
    test_patients_app_accessibility()
    test_patients_app_keyboard_navigation()
    print("\nüéâ ¬°Todos los tests de accesibilidad de la app de pacientes pasaron exitosamente!")